<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#CC785C">
    <title>Espresso Tracker</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* ... styles inchang√©s (identiques √† la version pr√©c√©dente) ... */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f5f1eb 0%, #e8dfd5 100%);
            padding: 0; 
            min-height: 100vh;
            position: relative;
            transition: background 0.5s ease;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('logo-bg.png');
            background-position: center center;
            background-repeat: no-repeat;
            background-size: 55%;
            opacity: 0.06;
            z-index: 999;
            pointer-events: none;
            transition: opacity 0.5s ease, background-image 0.5s ease;
        }
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-position: center center;
            background-repeat: no-repeat;
            background-size: cover;
            opacity: 0;
            z-index: 0;
            pointer-events: none;
            transition: opacity 0.5s ease, background-image 0.5s ease;
        }
        body.bg-gedeo::after {
            background-image: url('gedeo-bg.png');
            opacity: 0.45;
        }
        body.bg-timana::after {
            background-image: url('timana-bg.png');
            opacity: 0.45;
        }
        .header, .container, .tabs { position: relative; z-index: 1; }
        .header { 
            background: linear-gradient(135deg, #CC785C 0%, #B5674A 100%);
            color: white; 
            padding: 40px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            text-align: center;
            position: relative;
            z-index: 1000;
        }
        .header h1 { 
            font-family: 'Playfair Display', serif;
            font-size: 42px; 
            font-weight: 600;
            letter-spacing: 1px;
        }
        .hamburger-btn {
            position: fixed;
            top: 24px;
            left: 24px;
            z-index: 1001;
            background: white;
            border: none;
            padding: 14px;
            border-radius: 14px;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            transition: all 0.2s;
        }
        .hamburger-btn:hover {
            box-shadow: 0 6px 20px rgba(0,0,0,0.18);
            transform: scale(1.05);
        }
        .hamburger-icon {
            width: 26px;
            height: 20px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .hamburger-icon span {
            width: 100%;
            height: 3px;
            background: #CC785C;
            border-radius: 3px;
        }
        .side-menu {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100%;
            background: linear-gradient(135deg, #ffffff 0%, #f9f9f9 100%);
            box-shadow: 6px 0 30px rgba(0,0,0,0.15);
            z-index: 1000;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 100px 0 30px 0;
        }
        .side-menu.open {
            left: 0;
        }
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .menu-overlay.open {
            opacity: 1;
            pointer-events: all;
        }
        .menu-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px 32px;
            color: #555;
            font-size: 17px;
            font-weight: 500;
            border-left: 4px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        .menu-item .icon {
            font-size: 24px;
            transition: transform 0.2s;
        }
        .menu-item:hover {
            background: rgba(204, 120, 92, 0.08);
            border-left-color: #CC785C;
            color: #CC785C;
        }
        .menu-item:hover .icon {
            transform: scale(1.15);
        }
        .menu-item.active {
            background: rgba(204, 120, 92, 0.12);
            border-left-color: #CC785C;
            color: #CC785C;
            font-weight: 600;
        }
        .tabs { display: none !important; }
        .container { max-width: 920px; margin: 0 auto; padding: 40px 20px; }
        .section { 
            background: rgba(255, 255, 255, 0.80);
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 25px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.06);
            border: 1px solid rgba(204, 120, 92, 0.1);
            backdrop-filter: blur(10px);
        }
        h2 { 
            color: #CC785C;
            font-family: 'Playfair Display', serif;
            font-size: 26px;
            margin-bottom: 28px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .form-group { margin-bottom: 22px; }
        label { 
            display: block;
            margin-bottom: 10px;
            color: #3d3d3d;
            font-weight: 500;
            font-size: 14px;
            letter-spacing: 0.2px;
        }
        input, select, textarea { 
            width: 100%;
            padding: 14px 16px;
            border: 1.5px solid #e0d5c7;
            border-radius: 12px;
            font-size: 15px;
            background: rgba(250, 250, 248, 0.8);
            transition: all 0.2s;
            font-family: inherit;
        }
        input:focus, select:focus, textarea:focus { 
            outline: none;
            border-color: #CC785C;
            background: white;
            box-shadow: 0 0 0 4px rgba(204, 120, 92, 0.08);
        }
        .row { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
        }
        .btn { 
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #CC785C 0%, #B5674A 100%);
            color: white;
            width: 100%;
            box-shadow: 0 4px 12px rgba(204, 120, 92, 0.25);
        }
        .btn-primary:hover:not(:disabled) { 
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(204, 120, 92, 0.35);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-secondary { 
            background: #f0e6d9;
            color: #CC785C;
            padding: 10px 20px;
            font-size: 14px;
        }
        .btn-secondary:hover {
            background: #e8ddd0;
        }
        .btn-small { 
            padding: 9px 18px;
            font-size: 13px;
        }
        .btn-danger { 
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .shot-item { 
            background: linear-gradient(135deg, rgba(250, 250, 248, 0.75) 0%, rgba(245, 241, 235, 0.75) 100%);
            border: 1.5px solid rgba(204, 120, 92, 0.12);
            border-radius: 12px;
            padding: 14px 20px;
            margin-bottom: 10px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        .shot-item:hover { 
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border-color: #CC785C;
        }
        .shot-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 22px;
            padding-bottom: 18px;
            border-bottom: 1.5px solid rgba(204, 120, 92, 0.12);
        }
        .shot-title { 
            font-size: 19px;
            font-weight: 600;
            color: #CC785C;
            letter-spacing: 0.3px;
        }
        .bag-item { 
            background: linear-gradient(135deg, rgba(250, 250, 248, 0.75) 0%, rgba(245, 241, 235, 0.75) 100%);
            border: 1.5px solid rgba(204, 120, 92, 0.12);
            border-radius: 12px;
            padding: 14px 20px;
            margin-bottom: 10px;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }
        .bag-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            border-color: #CC785C;
        }
        .bag-item::before { 
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(250, 250, 248, 0.88);
            border-radius: 16px;
            z-index: 0;
        }
        .bag-item > * { position: relative; z-index: 1; }
        .bag-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .bag-title { 
            font-size: 19px;
            font-weight: 600;
            color: #CC785C;
            letter-spacing: 0.3px;
        }
        .bag-info { 
            margin-top: 12px;
            font-size: 14px;
            color: #666;
            line-height: 1.7;
        }
        .bag-status { 
            display: inline-block;
            padding: 7px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 12px;
            letter-spacing: 0.3px;
        }
        .bag-status.active { 
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
        }
        .bag-status.finished { 
            background: #9e9e9e;
            color: white;
        }
        .alert { 
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            font-weight: 500;
            font-size: 14px;
            border-left: 4px solid;
        }
        .alert-success { 
            background: #d4edda;
            color: #155724;
            border-color: #28a745;
        }
        .alert-error { 
            background: #f8d7da;
            color: #721c24;
            border-color: #dc3545;
        }
        .alert-info { 
            background: #e3f2fd;
            color: #0c5460;
            border-color: #17a2b8;
        }
        .chart-container { 
            position: relative;
            height: 420px;
            margin-top: 25px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 12px;
            padding: 20px;
        }
        .star-rating { 
            display: flex;
            gap: 10px;
            font-size: 32px;
            cursor: pointer;
        }
        .star { 
            color: #ddd;
            transition: all 0.2s;
            cursor: pointer;
        }
        .star.filled { 
            color: #ffc107;
            text-shadow: 0 2px 4px rgba(255, 193, 7, 0.3);
        }
        .star:hover { 
            transform: scale(1.15);
        }
        .star-display { 
            font-size: 18px;
            color: #ffc107;
            letter-spacing: 2px;
        }
        @media (max-width: 600px) { 
            .row { grid-template-columns: 1fr; }
            .container { padding: 25px 16px; }
            .section { padding: 25px 20px; }
            .header h1 { 
                font-size: 32px; 
                padding-left: 60px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>Espresso Tracker</h1>
    </div>
    
    <button class="hamburger-btn" onclick="window.toggleMenu()">
        <div class="hamburger-icon">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </button>
    
    <div class="menu-overlay" onclick="window.toggleMenu()"></div>
    
    <nav class="side-menu">
        <a class="menu-item" onclick="window.setTab('shots'); window.toggleMenu();">
            <span class="icon">‚òï</span>
            <span>Shots</span>
        </a>
        <a class="menu-item" onclick="window.setTab('bags'); window.toggleMenu();">
            <span class="icon">ü´ò</span>
            <span>Grains</span>
        </a>
        <a class="menu-item" onclick="window.setTab('analysis'); window.toggleMenu();">
            <span class="icon">üìä</span>
            <span>Analyse</span>
        </a>
        <a class="menu-item" onclick="window.setTab('settings'); window.toggleMenu();">
            <span class="icon">‚öôÔ∏è</span>
            <span>R√©glages</span>
        </a>
    </nav>
    
    <div id="app" class="container">
        <div style="text-align: center; padding: 60px; color: #CC785C;">‚è≥ Chargement...</div>
    </div>

    <script>
        const SUPABASE_URL = 'https://duzxzqmjkovrsfwhdyml.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1enh6cW1qa292cnNmd2hkeW1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NjAzMzYsImV4cCI6MjA4NjMzNjMzNn0.hRUDEbr9yhd_R1Q0lLVYYppnht5tUAd5TtE9kanzvos';
        const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentTab = 'shots';
        let shots = [];
        let bags = [];
        let message = null;
        let chartInstance = null;
        let currentRating = 0;
        let currentBagId = null;
        const appEl = document.getElementById('app');

        const LOGOS = {
            timana: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAACbUlEQVR4nO2bPVLDMBSEVxnOkQ5OQUtDTkBNmYaOM9DRUKbmBlSUnIKSjlOYgiiRZcnSk/WzzmgbMkNG8n5vnyx7IoW6GgTfVcWuouIkEsMhFbnWEoN6TQ/vN9GDqIfv2X8Lrmd+nlwDwWFcYjgkD5DF158DQFHjtnKDWArgZL6kaZ8sGEleUgGMqt7CvJYjESJPKQDOVd8f/j/cviQMk1epadgI55maB4CvZ+Ew+WWlMPr2KwHgNk+kFAixAMLmCVIAyCHEAIiv/AohhADQx96nWAhzANLMk6QAiIMQbIG1Vd5WaI/iAzAAC8wTpQAYQZikwAUgzyMsGQRDI3/eFlh79G35WsEGsCz6tshS4GoF6Vb44mQCyPn66iyyFBgaAEcCLq33bdlrQZ0W4E3B6bk57+LnE8F7Ay39/qAvglVnI2yFngDU6n8tkhTou0FPQJNZSVIAtEwACYTeAk1nJ0jBVesL2P1+Npx921ugKYDd9V3L6QE0BMBgHmi9CBJog+MjsXp7rDYpQ/U/nrYAegLqA2CovqmegOPfKusAS/V1/wNQ1RLAYt7WBEDNu0ELGdUHMAZQ7HfDpNVXQF8EJwCyL4ZM1TcXP/3Bm4BLWwvs3tdyAci2FjBV39DIny8Bi1uBybwr+lrBRXDtreCLvtYcgBMtKQSW6lvmna0dSkAyhNaKMQ/E7QNEEBiqH2seiN8IRUFYm3lAthOkbwepeUC+FfZCaF39FPOiL1oanxnaH5oBcNzmRJ5SH4YUCFrCUXVxQYucG7x//ckwrFuejU2zc4OmioLIbTzbAA55f3EqARLYwlKeHXaJ/vT4H4+IseLBtt/JAAAAAElFTkSuQmCC',
            gedeo: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAACcUlEQVR4nO2bvU7DMBSFTyo2dgZmNhaeAYmZHfYO3XkKdiTYeQDmCt6CjZWFvXNY6shx7NjX8c9J5bNQidbO+e65jhMlHcqqF3y3y3YUBSeRGPYpy7HmGNRp+vb9EDzI1+P53L+THXdKABPjEsM+OYAsPv4UALIaN5UaxFIAg/mcpl0yYER5iQUwqnoN80qWRIg8xQAYzG/3OwDAz99zxDBpFZuGjXCeiXkAuLp4Eg6TXkYKg0+/EgBW80yKgRAKwGueIQWAHEIIgODKrxGCDwB97F0KhTAHIMo8SwqAMAjeFlhb5U359iguAD0Qb54pBcAIwiQFNgBJLmHZIGga+XO2wNqjb8rVCiaARdE3xZYCWytIt8InJx1AyttXg9hSoKkHLAk4td43Za4FRVqAOAXDdXPSxc8lhvsGSur+QVsES07G2AotASjU/0osKVBng5aAGpOypAComAAWCK0Fak7OkIKz2gfwefNQbe4OrQXqAni9/K05PYCKABjMA60FsMHxkvjt7qXYpAzV764/ALQElAfAUH1dLQHHv0XWAZbqq/4H0BVLAIt5UxMAJc8GNaRVH8AYQLbnhkmr3wFtEZwASL4YMlVfX/zUB2cCTm0tMHtfyQYg2VrAVH1NI3+uBCxuBSbztugreRfBtbeCK/pKcwAGWlIILNU3zFtb25eAaAi1FWIeCNsHiCAwVD/UPBC+EQqCsDbzgGwnSN8OUvOAfCvshFC7+jHmRV80NHqibLvfVQNgOc1lf2dI1wCi/75fOJRcsVVf/CNDk+cLc8JwbGyqvTeoKyuI1MaTDWCR84lTCRDPFpby3WGb6N8e/wdHGbWdc2XBIwAAAABJRU5ErkJggg==',
            generic: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAACdUlEQVR4nO2bP07DMBjFXypuwYbETTgDExIDOwsLW8XWhYWdoRITZ0Bi4QLMSEyUiTuEpY4cx679Of7zUvktVKK1837f+xwnSjqUVS/4bpftKApOIjHsU5ZjzTGo0/Tb60vwIBeXV4f+ney4UwKYGJcY9skBZPbxpwCQ1bip1CDmAhjM5zTtkgEjykssgFHVa5hXsiRC5CkGwGB+u1kDAE7PziOGSavYNKyE80zMA8Du+0s4THoZKQw+/UoAWM0zKQZCKACveYYUAHIIIQCCK79ECD4A9LF3KRTCIQBR5llSAIRB8LbA0ipvyrdHcQHogXjzTCkARhAmKbABSHIJywZB08ifswWWHn1TrlYwAcyKvim2FNhaQboVPjrpAFLevhrElgJNPWBJwLH1vilzLSjSAsQpGK6bky5+LjHcN1BS9w/aIlhyMsZWaAlAof5XYkmBOhu0BNSYlCUFQMUEsEBoLVBzcoYUnNQ+gM+P96rztxaoOfnf70/N6QFUBMBgHmgtgBX2l8TX9w/FJmWo/t3TM4CWgPIAGKqvqyVg/7fIOsBSfdX/ALpiCWAxb2oCoOTZoIa06gMYA8j23DBp9TugLYITAMkXQ6bq64uf+uBMwLGtBWbvK9kAJFsLmKqvaeTPlYDZrcBk3hZ9Je8iuPRWcEVf6RCAgZYUAkv1DfPW1vYlIBpCbYWYB8L2ASIIDNUPNQ+Eb4SCICzNPCDbCdK3g9Q8IN8KOyHUrn6MedEXDY2eKNtu1tUAWE5z2d8Z0jWAeLy9mTmUXLFVn/0jQ5PnC3PCcGxsqr03qCsriNTGkw1gkfOJUwkQzxaW8t1hm+jfHv8HiQrra/56lPwAAAAASUVORK5CYII='
        };

        function getLogo(name) {
            if (!name) return LOGOS.generic;
            const n = name.toLowerCase();
            if (n.includes('timana') || n.includes('timan√†')) return LOGOS.timana;
            if (n.includes('gedeo') || n.includes('g√©d√©o')) return LOGOS.gedeo;
            return LOGOS.generic;
        }

        function updateBackground(bagId) {
            if (!bagId) {
                document.body.className = '';
                return;
            }
            const bag = bags.find(b => b.id.toString() === bagId);
            if (!bag) {
                document.body.className = '';
                return;
            }
            const n = bag.name.toLowerCase();
            if (n.includes('gedeo') || n.includes('g√©d√©o')) {
                document.body.className = 'bg-gedeo';
            } else if (n.includes('timana') || n.includes('timan√†')) {
                document.body.className = 'bg-timana';
            } else {
                document.body.className = '';
            }
        }

        function showMessage(type, text) {
            message = { type, text };
            setTimeout(() => { message = null; render(); }, 4000);
            render();
        }

        function renderStars(count) {
            let html = '';
            for (let i = 1; i <= 5; i++) {
                html += i <= count ? '‚òÖ' : '‚òÜ';
            }
            return html;
        }

        async function loadData() {
            try {
                const { data: s } = await sb.from('shots').select('*').order('created_at', { ascending: false });
                const { data: b } = await sb.from('bags').select('*').order('created_at', { ascending: false });
                shots = s || [];
                bags = b || [];
            } catch (e) {
                console.error(e);
                showMessage('error', '‚ùå Erreur de chargement');
            }
            render();
        }

        async function addShot(event) {
            event.preventDefault();
            const form = event.target;
            const selectedBag = bags.find(b => b.id.toString() === form.bag_id.value);
            
            // Calcul correct de l'√¢ge √† partir de la date du shot
            let age = 0;
            if (selectedBag && selectedBag.roast_date) {
                const [roastDay, roastMonth, roastYear] = selectedBag.roast_date.split('/');
                const roastDate = new Date(`${roastYear}-${roastMonth}-${roastDay}`);
                
                // Date du shot (format YYYY-MM-DD)
                const shotDateStr = form.shot_date.value;
                const [shotYear, shotMonth, shotDay] = shotDateStr.split('-');
                const shotDate = new Date(`${shotYear}-${shotMonth}-${shotDay}`);
                
                age = Math.floor((shotDate - roastDate) / 86400000);
                // Si la date du shot est ant√©rieure √† la torr√©faction, √¢ge n√©gatif => on met 0
                if (age < 0) age = 0;
            }

            const shotDate = form.shot_date.value;
            const [shotYear, shotMonth, shotDay] = shotDate.split('-');
            const formattedDate = `${shotDay}/${shotMonth}/${shotYear}`;

            const shot = {
                date: formattedDate,
                coffee: selectedBag ? selectedBag.name : '',
                roaster: selectedBag ? selectedBag.roaster : "L'Arbre √† Caf√©",
                roast_date: selectedBag ? selectedBag.roast_date : '',
                age,
                dose: parseFloat(form.dose.value),
                output: parseFloat(form.output.value),
                ratio: parseFloat((form.output.value / form.dose.value).toFixed(2)),
                grind: parseFloat(form.grind.value),
                time: parseInt(form.time.value),
                preinfusion: parseInt(form.preinfusion.value),
                wdt: form.wdt.value,
                remarks: form.remarks.value,
                rating: currentRating,
                validated: (currentRating === 4 || currentRating === 5)
            };

            const { data } = await sb.from('shots').insert([shot]).select();
            shots = [data[0], ...shots];
            showMessage('success', '‚úÖ Shot enregistr√©');
            form.reset();
            form.dose.value = 18;
            form.output.value = 38;
            form.grind.value = 7.5;
            form.time.value = 30;
            form.preinfusion.value = 8;
            currentRating = 0;
            render();
        }

        async function deleteShot(id) {
            if (!confirm('Supprimer ce shot ?')) return;
            try {
                await sb.from('shots').delete().eq('id', id);
                await loadData();
                showMessage('success', '‚úÖ Shot supprim√©');
            } catch (e) {
                console.error(e);
                showMessage('error', '‚ùå Erreur lors de la suppression');
            }
        }

        async function addBag(event) {
            event.preventDefault();
            const form = event.target;
            
            const dateInput = form.roast_date.value;
            const [year, month, day] = dateInput.split('-');
            const formattedDate = `${day}/${month}/${year}`;
            
            const bag = {
                name: form.name.value,
                roaster: form.roaster.value,
                roast_date: formattedDate,
                weight: parseInt(form.weight.value),
                notes: '',
                status: 'active'
            };
            const { data } = await sb.from('bags').insert([bag]).select();
            bags = [data[0], ...bags];
            showMessage('success', '‚úÖ Grains ajout√©s');
            form.reset();
            render();
        }

        async function toggleBag(id, status) {
            try {
                const newStatus = status === 'active' ? 'finished' : 'active';
                await sb.from('bags').update({ status: newStatus }).eq('id', id);
                await loadData();
            } catch (e) {
                console.error(e);
                showMessage('error', '‚ùå Erreur lors de la mise √† jour');
            }
        }

        async function deleteBag(id) {
            if (!confirm('Supprimer ce paquet ?')) return;
            try {
                await sb.from('bags').delete().eq('id', id);
                await loadData();
                showMessage('success', '‚úÖ Grains supprim√©s');
            } catch (e) {
                console.error(e);
                showMessage('error', '‚ùå Erreur lors de la suppression');
            }
        }

        async function importCSV(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const lines = ev.target.result.split('\n').filter(l => l.trim());
                    const shotsToImport = [];
                    const bagsToCreate = new Map();

                    for (let i = 1; i < lines.length; i++) {
                        const v = lines[i].split(',');
                        if (v.length < 10) continue;

                        const coffee = v[1].trim();
                        const roaster = v[2].trim();
                        const roast_date = v[3].trim();

                        const bagKey = `${coffee}|${roaster}|${roast_date}`;
                        if (!bagsToCreate.has(bagKey) && roast_date) {
                            bagsToCreate.set(bagKey, {
                                name: coffee,
                                roaster: roaster,
                                roast_date: roast_date,
                                weight: 250,
                                notes: '',
                                status: 'active'
                            });
                        }

                        const shotData = {
                            date: v[0].trim(),
                            coffee: coffee,
                            roaster: roaster,
                            roast_date: roast_date,
                            age: parseInt(v[4]) || 0,
                            dose: parseFloat(v[5]) || 18,
                            output: parseFloat(v[6]) || 36,
                            ratio: parseFloat(v[7]) || 2,
                            grind: parseFloat(v[8]) || 7.5,
                            time: parseInt(v[9]) || 0,
                            preinfusion: parseInt(v[10]) || 0,
                            wdt: v[11]?.trim() || 'non',
                            remarks: v[15]?.trim() || '',
                            rating: parseInt(v[14]) || 0,
                            validated: (parseInt(v[14]) === 4 || parseInt(v[14]) === 5)
                        };

                        const isDuplicate = shots.some(s => 
                            s.date === shotData.date &&
                            s.coffee === shotData.coffee &&
                            s.grind === shotData.grind &&
                            s.time === shotData.time
                        );

                        if (!isDuplicate) {
                            shotsToImport.push(shotData);
                        }
                    }

                    const newBags = [];
                    for (const [key, bag] of bagsToCreate) {
                        const exists = bags.some(b => 
                            b.name.toLowerCase() === bag.name.toLowerCase() && 
                            b.roast_date === bag.roast_date
                        );
                        if (!exists) {
                            newBags.push(bag);
                        }
                    }

                    if (newBags.length > 0) {
                        await sb.from('bags').insert(newBags);
                    }

                    if (shotsToImport.length > 0) {
                        await sb.from('shots').insert(shotsToImport);
                    }
                    
                    await loadData();
                    
                    const skipped = (lines.length - 1) - shotsToImport.length;
                    let msg = `‚úÖ ${shotsToImport.length} shots`;
                    if (newBags.length > 0) msg += ` et ${newBags.length} paquets`;
                    msg += ' import√©s';
                    if (skipped > 0) msg += ` (${skipped} doublons ignor√©s)`;
                    
                    showMessage('success', msg);
                } catch (e) {
                    console.error(e);
                    showMessage('error', '‚ùå Erreur: ' + e.message);
                }
            };
            reader.readAsText(file);
        }

        function exportCSV() {
            const h = ['Date shot','Caf√©','Torr√©facteur','Date torr√©faction','√Çge (jours)','Dose (g)','Sortie (g)','Ratio','Mouture','Temps (s)','Pr√©infusion (s)','WDT','Remarques','Note'];
            const rows = shots.map(s => [s.date,s.coffee,s.roaster,s.roast_date,s.age,s.dose,s.output,s.ratio,s.grind,s.time,s.preinfusion,s.wdt,s.remarks||'',s.rating||0].join(','));
            const csv = [h.join(','), ...rows].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `espresso_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // Analyse par nom de caf√© (sans restriction sur la note)
        function updateChartByCoffee(coffeeName) {
            const canvas = document.getElementById('chart');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            
            // Filtrer les shots dont le nom correspond (tous, sans condition de note)
            let filteredShots = shots.filter(s => 
                s.coffee && s.coffee.toLowerCase().includes(coffeeName.toLowerCase())
            );
            
            // Trier par √¢ge
            const sorted = filteredShots.sort((a, b) => a.age - b.age);
            const data = sorted.map(s => ({ x: s.age, y: s.grind }));
            
            if (chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'scatter',
                data: { 
                    datasets: [{ 
                        label: `${coffeeName} - Mouture vs √Çge (tous shots)`, 
                        data: data, 
                        backgroundColor: 'rgba(204, 120, 92, 0.7)', 
                        borderColor: '#CC785C', 
                        borderWidth: 2, 
                        pointRadius: 9, 
                        pointHoverRadius: 11 
                    }] 
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { 
                            title: { 
                                display: true, 
                                text: '√Çge du caf√© (jours depuis torr√©faction)', 
                                font: { size: 13, weight: '600' }, 
                                color: '#CC785C' 
                            } 
                        },
                        y: { 
                            title: { 
                                display: true, 
                                text: 'Mouture', 
                                font: { size: 13, weight: '600' }, 
                                color: '#CC785C' 
                            } 
                        }
                    },
                    plugins: {
                        legend: { 
                            display: true, 
                            labels: { font: { size: 13, weight: '500' } } 
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const shot = sorted[context.dataIndex];
                                    return [
                                        `Caf√©: ${shot.coffee}`,
                                        `Torr√©faction: ${shot.roast_date}`,
                                        `Mouture: ${shot.grind}`, 
                                        `√Çge: ${shot.age}j`, 
                                        `Temps: ${shot.time}s`,
                                        `Note: ${renderStars(shot.rating)}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        function render() {
            const activeBags = bags.filter(b => b.status === 'active');
            let html = `<div class="tabs">
                <button class="tab ${currentTab === 'shots' ? 'active' : ''}" onclick="window.setTab('shots')">Shots</button>
                <button class="tab ${currentTab === 'bags' ? 'active' : ''}" onclick="window.setTab('bags')">Paquets</button>
                <button class="tab ${currentTab === 'analysis' ? 'active' : ''}" onclick="window.setTab('analysis')">Analyse</button>
                <button class="tab ${currentTab === 'settings' ? 'active' : ''}" onclick="window.setTab('settings')">R√©glages</button>
            </div>`;
            if (message) html += `<div class="alert alert-${message.type}">${message.text}</div>`;
            
            if (currentTab === 'shots') {
                html += `<div class="section"><h2>Nouveau Shot</h2>
                    <form id="form-shot" onsubmit="event.preventDefault(); window.addShot(event)">
                    <div class="form-group"><label>Grains</label><select name="bag_id" required onchange="window.updateBackground(this.value); window.currentBagId = this.value;"><option value="">S√©lectionner</option>
                    ${activeBags.map(b => `<option value="${b.id}">${b.name}</option>`).join('')}</select></div>
                    <div class="form-group"><label>Date du shot</label><input type="date" name="shot_date" required></div>
                    <div class="row"><div class="form-group"><label>Dose (g)</label><input type="number" step="0.1" name="dose" value="18" required></div>
                    <div class="form-group"><label>Sortie (g)</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button type="button" onclick="const el = document.querySelector('input[name=output]'); el.value = (parseFloat(el.value) - 1).toFixed(1);" class="btn btn-secondary btn-small" style="width:40px; padding:8px;">‚àí</button>
                        <input type="number" step="0.1" name="output" value="38" required style="flex:1;">
                        <button type="button" onclick="const el = document.querySelector('input[name=output]'); el.value = (parseFloat(el.value) + 1).toFixed(1);" class="btn btn-secondary btn-small" style="width:40px; padding:8px;">+</button>
                    </div></div></div>
                    <div class="row"><div class="form-group"><label>Mouture</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button type="button" onclick="const el = document.querySelector('input[name=grind]'); el.value = (parseFloat(el.value) - 0.1).toFixed(1);" class="btn btn-secondary btn-small" style="width:40px; padding:8px;">‚àí</button>
                        <input type="number" step="0.1" name="grind" value="7.5" required style="flex:1;">
                        <button type="button" onclick="const el = document.querySelector('input[name=grind]'); el.value = (parseFloat(el.value) + 0.1).toFixed(1);" class="btn btn-secondary btn-small" style="width:40px; padding:8px;">+</button>
                    </div></div>
                    <div class="form-group"><label>Temps (s)</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button type="button" onclick="const el = document.querySelector('input[name=time]'); el.value = parseInt(el.value) - 1;" class="btn btn-secondary btn-small" style="width:40px; padding:8px;">‚àí</button>
                        <input type="number" name="time" value="30" required style="flex:1;">
                        <button type="button" onclick="const el = document.querySelector('input[name=time]'); el.value = parseInt(el.value) + 1;" class="btn btn-secondary btn-small" style="width:40px; padding:8px;">+</button>
                    </div></div></div>
                    <div class="row"><div class="form-group"><label>Pr√©infusion (s)</label>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button type="button" onclick="const el = document.querySelector('input[name=preinfusion]'); el.value = parseInt(el.value) - 1;" class="btn btn-secondary btn-small" style="width:40px; padding:8px;">‚àí</button>
                        <input type="number" name="preinfusion" value="8" style="flex:1;">
                        <button type="button" onclick="const el = document.querySelector('input[name=preinfusion]'); el.value = parseInt(el.value) + 1;" class="btn btn-secondary btn-small" style="width:40px; padding:8px;">+</button>
                    </div></div>
                    <div class="form-group"><label>WDT</label><select name="wdt"><option value="non">Non</option><option value="l√©ger">L√©ger</option>
                    <option value="normal">Normal</option><option value="profond">Profond</option></select></div></div>
                    <div class="form-group"><label>Remarques</label><textarea name="remarks" rows="2" placeholder="Notes sur ce shot..."></textarea></div>
                    <div class="form-group">
                        <div class="star-rating">
                    ${[1,2,3,4,5].map(i => `<span class="star ${i <= currentRating ? 'filled' : ''}" onclick="window.setRating(${i})">‚òÖ</span>`).join('')}</div></div>
                    <button type="submit" class="btn btn-primary">Enregistrer</button></form></div>
                    <div class="section"><h2>Historique (${shots.length})</h2>
                    ${shots.length === 0 ? '<p style="text-align:center; color:#888; padding:40px;">Aucun shot enregistr√©</p>' : ''}`;
                shots.forEach(s => {
                    html += `<div class="shot-item" style="padding:14px 20px; margin-bottom:10px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <img src="${getLogo(s.coffee)}" style="width:28px; height:28px; border-radius:50%; border: 1.5px solid rgba(204, 120, 92, 0.2);">
                            <div style="flex:1; font-size:13px; color:#555; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                                <strong style="color:#CC785C; font-size:14px;">${s.coffee}</strong>
                                <span style="cursor:pointer;" onclick="window.updateShotRating('${s.id}', ${s.rating || 0})">${[1,2,3,4,5].map(i => `<span style="color:${i <= (s.rating || 0) ? '#ffc107' : '#ddd'}; font-size:13px;">‚òÖ</span>`).join('')}</span>
                                <span style="color:#999;">¬∑</span>
                                <span>${s.dose}‚Üí${s.output}g</span>
                                <span>‚öôÔ∏è${s.grind}</span>
                                <span>‚è±Ô∏è${s.time}s</span>
                                <span>üíß${s.preinfusion}s</span>
                                <span>üìÖ${s.age}j</span>
                                <span>üåÄ${s.wdt}</span>
                                <span style="color:#aaa; font-size:12px;">${s.date}</span>
                                ${s.remarks ? `<span style="color:#999; font-style:italic; font-size:12px;">üí¨ ${s.remarks}</span>` : ''}
                            </div>
                            <button class="btn btn-danger btn-small" onclick="window.deleteShot('${s.id}')" style="padding:6px 12px; font-size:12px;">‚úï</button>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            }
            else if (currentTab === 'bags') {
                html += `<div class="section"><h2>Nouveaux Grains</h2><form id="form-bag" onsubmit="event.preventDefault(); window.addBag(event)">
                    <div class="form-group"><label>Nom du caf√©</label><input type="text" name="name" placeholder="G√©d√©o, Timan√†..." required></div>
                    <div class="form-group"><label>Torr√©facteur</label><input type="text" name="roaster" value="L'Arbre √† Caf√©"></div>
                    <div class="row"><div class="form-group"><label>Date torr√©faction</label>
                    <input type="date" name="roast_date" required></div>
                    <div class="form-group"><label>Poids (g)</label><input type="number" name="weight" value="250"></div></div>
                    <button type="submit" class="btn btn-primary">Ajouter</button></form></div>
                    <div class="section"><h2>Mes Grains (${bags.length})</h2>${bags.length === 0 ? '<p style="text-align:center; color:#888; padding:40px;">Aucuns grains</p>' : ''}`;
                bags.forEach(b => {
                    let age = 0;
                    if (b.roast_date) {
                        const [day, month, year] = b.roast_date.split('/');
                        const roastDate = new Date(`${year}-${month}-${day}`);
                        age = Math.floor((new Date() - roastDate) / 86400000);
                    }
                    html += `<div class="bag-item" style="padding:14px 20px; margin-bottom:10px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <img src="${getLogo(b.name)}" style="width:28px; height:28px; border-radius:50%; border: 1.5px solid rgba(204, 120, 92, 0.2);">
                            <div style="flex:1; font-size:13px; color:#555; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                                <strong style="color:#CC785C; font-size:14px;">${b.name}</strong>
                                <span style="color:#999;">¬∑</span>
                                <span>${b.roaster}</span>
                                <span>üìÖ ${b.roast_date}</span>
                                <span>‚è≥ ${age}j</span>
                                <span>‚öñÔ∏è ${b.weight}g</span>
                                <span class="bag-status ${b.status}" style="padding:4px 10px; font-size:11px;">${b.status === 'active' ? '‚úì Actif' : '‚óã Termin√©'}</span>
                            </div>
                            <div style="display:flex; gap:8px;">
                                <button class="btn btn-secondary btn-small" onclick="window.toggleBag('${b.id}', '${b.status}')" style="padding:6px 12px; font-size:12px;">${b.status === 'active' ? 'Terminer' : 'R√©activer'}</button>
                                <button class="btn btn-danger btn-small" onclick="window.deleteBag('${b.id}')" style="padding:6px 12px; font-size:12px;">‚úï</button>
                            </div>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            }
            else if (currentTab === 'analysis') {
                // Extraire les noms de caf√© uniques des bags
                const coffeeNames = [...new Set(bags.map(b => b.name))].sort();
                // D√©terminer le dernier caf√© utilis√© (shot le plus r√©cent)
                let lastCoffee = '';
                if (shots.length > 0) {
                    lastCoffee = shots[0].coffee; // le plus r√©cent car tri√©s par date d√©croissante
                } else if (coffeeNames.length > 0) {
                    lastCoffee = coffeeNames[0];
                }

                html += `<div class="section"><h2>Analyse : Mouture vs √Çge</h2>`;
                // Ligne supprim√©e : "Seuls les shots valid√©s..."
                if (coffeeNames.length === 0) {
                    html += `<div class="alert alert-info">Ajoutez des grains pour voir l'analyse</div>`;
                } else {
                    html += `<div class="form-group"><label>S√©lectionner un caf√©</label>
                        <select id="analysis-coffee" onchange="window.updateChartByCoffee(this.value)">
                        ${coffeeNames.map(name => `<option value="${name}" ${name === lastCoffee ? 'selected' : ''}>${name}</option>`).join('')}
                        </select></div>
                        <div class="chart-container"><canvas id="chart"></canvas></div>`;
                    // Appeler la mise √† jour apr√®s le rendu
                    setTimeout(() => window.updateChartByCoffee(lastCoffee), 100);
                }
                html += `</div>`;
            }
            else if (currentTab === 'settings') {
                html += `<div class="section"><h2>R√©glages</h2><div class="alert alert-success">‚úÖ Synchronis√© avec Supabase</div>
                    <h3 style="margin: 28px 0 16px; font-size: 16px; font-weight: 600; color: #CC785C;">Importer des donn√©es CSV</h3>
                    <p style="margin-bottom:16px; color:#666; font-size: 14px;">Les paquets manquants seront cr√©√©s automatiquement</p>
                    <input type="file" accept=".csv" onchange="window.importCSV(this.files[0])" style="width: 100%; padding: 16px; border: 2px dashed #CC785C; border-radius: 12px; background: rgba(250, 250, 248, 0.8); font-size: 15px; color: #CC785C; font-weight: 500; cursor: pointer;">
                    <h3 style="margin: 32px 0 16px; font-size: 16px; font-weight: 600; color: #CC785C;">Exporter les donn√©es</h3>
                    <p style="margin-bottom:16px; color:#666; font-size: 14px;">${shots.length} shots enregistr√©s</p>
                    <button class="btn btn-primary" onclick="window.exportCSV()" style="width:auto; padding: 14px 32px;" ${shots.length === 0 ? 'disabled' : ''}>üì• T√©l√©charger CSV</button></div>`;
            }
            appEl.innerHTML = html;
            
            if (currentBagId) {
                updateBackground(currentBagId);
            }
            
            if (currentTab === 'shots') {
                const shotDateInput = document.querySelector('input[name="shot_date"]');
                if (shotDateInput && !shotDateInput.value) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    shotDateInput.value = `${year}-${month}-${day}`;
                }
                
                if (shots.length > 0) {
                    const lastShot = shots[0];
                    const form = document.getElementById('form-shot');
                    if (form && !form.bag_id.value) {
                        const lastBag = bags.find(b => b.name === lastShot.coffee && b.roast_date === lastShot.roast_date);
                        if (lastBag) {
                            form.bag_id.value = lastBag.id;
                            currentBagId = lastBag.id;
                            updateBackground(lastBag.id);
                        }
                        form.dose.value = lastShot.dose || 18;
                        form.output.value = lastShot.output || 38;
                        form.grind.value = lastShot.grind || 7.5;
                        form.time.value = lastShot.time || 30;
                        form.preinfusion.value = lastShot.preinfusion || 8;
                        form.wdt.value = lastShot.wdt || 'non';
                    }
                }
                
                if (shotDateInput) {
                    setTimeout(() => shotDateInput.focus(), 100);
                }
            }
        }

        window.toggleMenu = function() {
            const menu = document.querySelector('.side-menu');
            const overlay = document.querySelector('.menu-overlay');
            menu.classList.toggle('open');
            overlay.classList.toggle('open');
            
            document.querySelectorAll('.menu-item').forEach((item, index) => {
                const tabs = ['shots', 'bags', 'analysis', 'settings'];
                if (tabs[index] === currentTab) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        };
        
        window.setTab = function(tab) { currentTab = tab; render(); };
        window.setRating = function(rating) { 
            currentRating = rating;
            document.querySelectorAll('.star-rating .star').forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('filled');
                } else {
                    star.classList.remove('filled');
                }
            });
        };
        
        window.updateShotRating = async function(shotId, currentRating) {
            const newRating = prompt(`Note actuelle: ${currentRating} √©toiles\n\nNouvelle note (1-5):`, currentRating);
            if (newRating === null) return;
            
            const rating = parseInt(newRating);
            if (isNaN(rating) || rating < 0 || rating > 5) {
                showMessage('error', '‚ùå Note invalide (entre 0 et 5)');
                return;
            }
            
            try {
                const validated = (rating === 4 || rating === 5);
                await sb.from('shots').update({ rating: rating, validated: validated }).eq('id', shotId);
                
                shots = shots.map(s => s.id === shotId ? { ...s, rating: rating, validated: validated } : s);
                
                showMessage('success', `‚úÖ Note mise √† jour: ${rating} √©toile${rating > 1 ? 's' : ''}`);
                render();
            } catch (e) {
                console.error(e);
                showMessage('error', '‚ùå Erreur lors de la mise √† jour');
            }
        };
        
        window.addShot = addShot;
        window.deleteShot = deleteShot;
        window.addBag = addBag;
        window.toggleBag = toggleBag;
        window.deleteBag = deleteBag;
        window.importCSV = importCSV;
        window.exportCSV = exportCSV;
        window.updateChartByCoffee = updateChartByCoffee;
        window.updateBackground = updateBackground;

        loadData();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6f4e37">
    <title>Espresso Tracker</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .tab.active {
            color: #6f4e37;
            border-bottom-color: #6f4e37;
            font-weight: 600;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #6f4e37;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #6f4e37;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5a3d2a;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .shot-list, .bag-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .shot-card, .bag-card {
            background: #fafafa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .shot-header, .bag-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .shot-title, .bag-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .shot-date {
            font-size: 14px;
            color: #888;
        }
        
        .shot-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        
        .detail {
            color: #666;
        }
        
        .detail strong {
            color: #333;
        }
        
        .import-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #6f4e37 0%, #5a3d2a 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }
        
        .alert-success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .bag-info {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }
        
        .bag-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .bag-status.active {
            background: #4caf50;
            color: white;
        }
        
        .bag-status.finished {
            background: #9e9e9e;
            color: white;
        }
        
        @media (max-width: 600px) {
            .two-col {
                grid-template-columns: 1fr;
            }
            
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .tab {
                font-size: 14px;
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ========================================
        // LOGOS DES CAF√âS
        // ========================================
        const COFFEE_LOGOS = {
            'timana': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAACbUlEQVR4nO2bPVLDMBSEVxnOkQ5OQUtDTkBNmYaOM9DRUKbmBlSUnIKSjlOYgiiRZcnSk/WzzmgbMkNG8n5vnyx7IoW6GgTfVcWuouIkEsMhFbnWEoN6TQ/vN9GDqIfv2X8Lrmd+nlwDwWFcYjgkD5DF158DQFHjtnKDWArgZL6kaZ8sGEleUgGMqt7CvJYjESJPKQDOVd8f/j/cviQMk1epadgI55maB4CvZ+Ew+WWlMPr2KwHgNk+kFAixAMLmCVIAyCHEAIiv/AohhADQx96nWAhzANLMk6QAiIMQbIG1Vd5WaI/iAzAAC8wTpQAYQZikwAUgzyMsGQRDI3/eFlh79G35WsEGsCz6tshS4GoF6Vb44mQCyPn66iyyFBgaAEcCLq33bdlrQZ0W4E3B6bk57+LnE8F7Ay39/qAvglVnI2yFngDU6n8tkhTou0FPQJNZSVIAtEwACYTeAk1nJ0jBVesL2P1+Npx921ugKYDd9V3L6QE0BMBgHmi9CBJog+MjsXp7rDYpQ/U/nrYAegLqA2CovqmegOPfKusAS/V1/wNQ1RLAYt7WBEDNu0ELGdUHMAZQ7HfDpNVXQF8EJwCyL4ZM1TcXP/3Bm4BLWwvs3tdyAci2FjBV39DIny8Bi1uBybwr+lrBRXDtreCLvtYcgBMtKQSW6lvmna0dSkAyhNaKMQ/E7QNEEBiqH2seiN8IRUFYm3lAthOkbwepeUC+FfZCaF39FPOiL1oanxnaH5oBcNzmRJ5SH4YUCFrCUXVxQYucG7x//ckwrFuejU2zc4OmioLIbTzbAA55f3EqARLYwlKeHXaJ/vT4H4+IseLBtt/JAAAAAElFTkSuQmCC',
            'gedeo': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAACcUlEQVR4nO2bvU7DMBSFTyo2dgZmNhaeAYmZHfYO3XkKdiTYeQDmCt6CjZWFvXNY6shx7NjX8c9J5bNQidbO+e65jhMlHcqqF3y3y3YUBSeRGPYpy7HmGNRp+vb9EDzI1+P53L+THXdKABPjEsM+OYAsPv4UALIaN5UaxFIAg/mcpl0yYER5iQUwqnoN80qWRIg8xQAYzG/3OwDAz99zxDBpFZuGjXCeiXkAuLp4Eg6TXkYKg0+/EgBW80yKgRAKwGueIQWAHEIIgODKrxGCDwB97F0KhTAHIMo8SwqAMAjeFlhb5U359iguAD0Qb54pBcAIwiQFNgBJLmHZIGga+XO2wNqjb8rVCiaARdE3xZYCWytIt8InJx1AyttXg9hSoKkHLAk4td43Za4FRVqAOAXDdXPSxc8lhvsGSur+QVsES07G2AotASjU/0osKVBng5aAGpOypAComAAWCK0Fak7OkIKz2gfwefNQbe4OrQXqAni9/K05PYCKABjMA60FsMHxkvjt7qXYpAzV764/ALQElAfAUH1dLQHHv0XWAZbqq/4H0BVLAIt5UxMAJc8GNaRVH8AYQLbnhkmr3wFtEZwASL4YMlVfX/zUB2cCTm0tMHtfyQYg2VrAVH1NI3+uBCxuBSbztugreRfBtbeCK/pKcwAGWlIILNU3zFtb25eAaAi1FWIeCNsHiCAwVD/UPBC+EQqCsDbzgGwnSN8OUvOAfCvshFC7+jHmRV80NHqibLvfVQNgOc1lf2dI1wCi/75fOJRcsVVf/CNDk+cLc8JwbGyqvTeoKyuI1MaTDWCR84lTCRDPFpby3WGb6N8e/wdHGbWdc2XBIwAAAABJRU5ErkJggg==',
            'generic': 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAACdUlEQVR4nO2bP07DMBjFXypuwYbETTgDExIDOwsLW8XWhYWdoRITZ0Bi4QLMSEyUiTuEpY4cx679Of7zUvktVKK1837f+xwnSjqUVS/4bpftKApOIjHsU5ZjzTGo0/Tb60vwIBeXV4f+ney4UwKYGJcY9skBZPbxpwCQ1bip1CDmAhjM5zTtkgEjykssgFHVa5hXsiRC5CkGwGB+u1kDAE7PziOGSavYNKyE80zMA8Du+0s4THoZKQw+/UoAWM0zKQZCKACveYYUAHIIIQCCK79ECD4A9LF3KRTCIQBR5llSAIRB8LbA0ipvyrdHcQHogXjzTCkARhAmKbABSHIJywZB08ifswWWHn1TrlYwAcyKvim2FNhaQboVPjrpAFLevhrElgJNPWBJwLH1vilzLSjSAsQpGK6bky5+LjHcN1BS9w/aIlhyMsZWaAlAof5XYkmBOhu0BNSYlCUFQMUEsEBoLVBzcoYUnNQ+gM+P96rztxaoOfnf70/N6QFUBMBgHmgtgBX2l8TX9w/FJmWo/t3TM4CWgPIAGKqvqyVg/7fIOsBSfdX/ALpiCWAxb2oCoOTZoIa06gMYA8j23DBp9TugLYITAMkXQ6bq64uf+uBMwLGtBWbvK9kAJFsLmKqvaeTPlYDZrcBk3hZ9Je8iuPRWcEVf6RCAgZYUAkv1DfPW1vYlIBpCbYWYB8L2ASIIDNUPNQ+Eb4SCICzNPCDbCdK3g9Q8IN8KOyHUrn6MedEXDY2eKNtu1tUAWE5z2d8Z0jWAeLy9mTmUXLFVn/0jQ5PnC3PCcGxsqr03qCsriNTGkw1gkfOJUwkQzxaW8t1hm+jfHv8HiQrra/56lPwAAAAASUVORK5CYII='
        };

        // Fonction pour d√©terminer le logo √† utiliser
        function getCoffeeLogo(coffeeName) {
            if (!coffeeName) return COFFEE_LOGOS.generic;
            
            const name = coffeeName.toLowerCase();
            if (name.includes('timana') || name.includes('timan√†')) return COFFEE_LOGOS.timana;
            if (name.includes('gedeo') || name.includes('g√©d√©o')) return COFFEE_LOGOS.gedeo;
            return COFFEE_LOGOS.generic;
        }

        // ========================================
        // CONFIGURATION SUPABASE  
        // ========================================
        // Configuration Supabase
        const SUPABASE_URL = 'https://duzxzqmjkovrsfwhdyml.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1enh6cW1qa292cnNmd2hkeW1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NjAzMzYsImV4cCI6MjA4NjMzNjMzNn0.hRUDEbr9yhd_R1Q0lLVYYppnht5tUAd5TtE9kanzvos';

        // Initialiser Supabase
        let supabase = null;
        let supabaseReady = false;

        try {
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                supabaseReady = true;
                console.log('‚úÖ Supabase initialis√©');
            }
        } catch (error) {
            console.error('‚ùå Erreur Supabase:', error);
        }

        // ========================================
        // COMPOSANT PRINCIPAL
        // ========================================
        function EspressoTracker() {
            const [activeTab, setActiveTab] = useState('shots');
            const [shots, setShots] = useState([]);
            const [bags, setBags] = useState([]);
            const [loading, setLoading] = useState(true);
            const [message, setMessage] = useState(null);

            useEffect(() => {
                if (supabaseReady) {
                    loadData();
                } else {
                    setLoading(false);
                    setMessage({ type: 'warning', text: '‚ö†Ô∏è Supabase non configur√©. Voir SUPABASE_SETUP.md' });
                }
            }, []);

            async function loadData() {
                try {
                    setLoading(true);
                    
                    // Charger les shots
                    const { data: shotsData, error: shotsError } = await supabase
                        .from('shots')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (shotsError) throw shotsError;
                    setShots(shotsData || []);
                    
                    // Charger les paquets
                    const { data: bagsData, error: bagsError } = await supabase
                        .from('bags')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (bagsError) throw bagsError;
                    setBags(bagsData || []);
                    
                    console.log(`‚úÖ Charg√©: ${shotsData?.length || 0} shots, ${bagsData?.length || 0} paquets`);
                } catch (error) {
                    console.error('Erreur chargement:', error);
                    showMessage('error', 'Erreur lors du chargement: ' + error.message);
                } finally {
                    setLoading(false);
                }
            }

            function showMessage(type, text) {
                setMessage({ type, text });
                setTimeout(() => setMessage(null), 5000);
            }

            async function addShot(shot) {
                try {
                    const { data, error } = await supabase
                        .from('shots')
                        .insert([shot])
                        .select();
                    
                    if (error) throw error;
                    
                    setShots([data[0], ...shots]);
                    showMessage('success', '‚úÖ Shot enregistr√© !');
                    setActiveTab('shots');
                } catch (error) {
                    console.error('Erreur ajout shot:', error);
                    showMessage('error', '‚ùå Erreur: ' + error.message);
                }
            }

            async function deleteShot(id) {
                try {
                    const { error } = await supabase
                        .from('shots')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    setShots(shots.filter(s => s.id !== id));
                    showMessage('success', '‚úÖ Shot supprim√©');
                } catch (error) {
                    console.error('Erreur suppression:', error);
                    showMessage('error', '‚ùå Erreur: ' + error.message);
                }
            }

            async function addBag(bag) {
                try {
                    const { data, error } = await supabase
                        .from('bags')
                        .insert([bag])
                        .select();
                    
                    if (error) throw error;
                    
                    setBags([data[0], ...bags]);
                    showMessage('success', '‚úÖ Paquet ajout√© !');
                    setActiveTab('bags');
                } catch (error) {
                    console.error('Erreur ajout paquet:', error);
                    showMessage('error', '‚ùå Erreur: ' + error.message);
                }
            }

            async function updateBag(id, updates) {
                try {
                    const { error } = await supabase
                        .from('bags')
                        .update(updates)
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    setBags(bags.map(bag => bag.id === id ? { ...bag, ...updates } : bag));
                    showMessage('success', '‚úÖ Paquet mis √† jour');
                } catch (error) {
                    console.error('Erreur mise √† jour:', error);
                    showMessage('error', '‚ùå Erreur: ' + error.message);
                }
            }

            async function deleteBag(id) {
                try {
                    const { error } = await supabase
                        .from('bags')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    setBags(bags.filter(b => b.id !== id));
                    showMessage('success', '‚úÖ Paquet supprim√©');
                } catch (error) {
                    console.error('Erreur suppression:', error);
                    showMessage('error', '‚ùå Erreur: ' + error.message);
                }
            }

            async function handleImportCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(l => l.trim());
                        
                        const shotsToImport = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',');
                            if (values.length < 10) continue;
                            
                            const shot = {
                                date: values[0].trim(),
                                coffee: values[1].trim(),
                                roaster: values[2].trim(),
                                roast_date: values[3].trim(),
                                age: parseInt(values[4]) || 0,
                                dose: parseFloat(values[5]) || 18,
                                output: parseFloat(values[6]) || 36,
                                ratio: parseFloat(values[7]) || 2,
                                grind: parseFloat(values[8]) || 7.5,
                                time: parseInt(values[9]) || 0,
                                preinfusion: parseInt(values[10]) || 0,
                                wdt: values[11]?.trim() || 'non',
                                channeling: values[12]?.trim() || 'non',
                                flow: values[13]?.trim() || 'stable',
                                taste: values[14]?.trim() || '',
                                notes: values[15]?.trim() || ''
                            };
                            
                            shotsToImport.push(shot);
                        }
                        
                        const { error } = await supabase
                            .from('shots')
                            .insert(shotsToImport);
                        
                        if (error) throw error;
                        
                        await loadData();
                        showMessage('success', `‚úÖ ${shotsToImport.length} shots import√©s !`);
                    } catch (error) {
                        console.error(error);
                        showMessage('error', '‚ùå Erreur import: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }

            function exportCSV() {
                const headers = ['Date shot', 'Caf√©', 'Torr√©facteur', 'Date torr√©faction', '√Çge (jours)', 
                               'Dose (g)', 'Sortie (g)', 'Ratio', 'Mouture', 'Temps (s)', 'Pr√©infusion (s)',
                               'WDT', 'Channeling', 'D√©bit', 'Go√ªt', 'Notes'];
                
                const rows = shots.map(shot => [
                    shot.date,
                    shot.coffee,
                    shot.roaster,
                    shot.roast_date,
                    shot.age,
                    shot.dose,
                    shot.output,
                    shot.ratio,
                    shot.grind,
                    shot.time,
                    shot.preinfusion,
                    shot.wdt,
                    shot.channeling,
                    shot.flow,
                    shot.taste,
                    shot.notes
                ].join(','));
                
                const csv = [headers.join(','), ...rows].join('\n');
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `espresso_data_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }

            if (loading) {
                return (
                    <div className="container">
                        <div className="loading">
                            <h1>‚òï Chargement...</h1>
                        </div>
                    </div>
                );
            }

            if (!supabaseReady) {
                return (
                    <div className="container">
                        <h1>‚òï Espresso Tracker</h1>
                        <div className="card">
                            <div className="alert alert-warning">
                                <h3>‚ö†Ô∏è Configuration requise</h3>
                                <p>Modifiez les lignes 282-283 dans le code HTML avec vos cl√©s Supabase.</p>
                                <p style={{ marginTop: '10px' }}>Voir le fichier <strong>SUPABASE_SETUP.md</strong> pour les instructions compl√®tes.</p>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    <h1>‚òï Espresso Tracker</h1>
                    
                    {message && (
                        <div className={`alert alert-${message.type}`}>
                            {message.text}
                        </div>
                    )}
                    
                    <div className="tabs">
                        <button 
                            className={`tab ${activeTab === 'shots' ? 'active' : ''}`}
                            onClick={() => setActiveTab('shots')}
                        >
                            Shots
                        </button>
                        <button 
                            className={`tab ${activeTab === 'add-shot' ? 'active' : ''}`}
                            onClick={() => setActiveTab('add-shot')}
                        >
                            + Shot
                        </button>
                        <button 
                            className={`tab ${activeTab === 'bags' ? 'active' : ''}`}
                            onClick={() => setActiveTab('bags')}
                        >
                            Paquets
                        </button>
                        <button 
                            className={`tab ${activeTab === 'add-bag' ? 'active' : ''}`}
                            onClick={() => setActiveTab('add-bag')}
                        >
                            + Paquet
                        </button>
                        <button 
                            className={`tab ${activeTab === 'stats' ? 'active' : ''}`}
                            onClick={() => setActiveTab('stats')}
                        >
                            Stats
                        </button>
                        <button 
                            className={`tab ${activeTab === 'settings' ? 'active' : ''}`}
                            onClick={() => setActiveTab('settings')}
                        >
                            ‚öôÔ∏è
                        </button>
                    </div>

                    {activeTab === 'shots' && <ShotsList shots={shots} onDelete={deleteShot} />}
                    {activeTab === 'add-shot' && <AddShot bags={bags} onAdd={addShot} />}
                    {activeTab === 'bags' && <BagsList bags={bags} onUpdate={updateBag} onDelete={deleteBag} />}
                    {activeTab === 'add-bag' && <AddBag onAdd={addBag} />}
                    {activeTab === 'stats' && <Stats shots={shots} bags={bags} />}
                    {activeTab === 'settings' && (
                        <Settings 
                            onImport={handleImportCSV}
                            onExport={exportCSV}
                            shotCount={shots.length}
                        />
                    )}
                </div>
            );
        }

        // ========================================
        // LISTE DES SHOTS
        // ========================================
        function ShotsList({ shots, onDelete }) {
            if (shots.length === 0) {
                return (
                    <div className="card">
                        <div className="alert alert-info">
                            Aucun shot enregistr√©. Importez vos donn√©es ou ajoutez un nouveau shot !
                        </div>
                    </div>
                );
            }

            return (
                <div className="shot-list">
                    {shots.map(shot => (
                        <div key={shot.id} className="shot-card">
                            <div className="shot-header">
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>
                                    <img 
                                        src={getCoffeeLogo(shot.coffee)} 
                                        alt={shot.coffee}
                                        style={{ width: '32px', height: '32px', borderRadius: '50%' }}
                                    />
                                    <div>
                                        <div className="shot-title">{shot.coffee}</div>
                                        <div className="shot-date">{shot.date}</div>
                                    </div>
                                </div>
                                <button 
                                    className="btn btn-danger btn-small"
                                    onClick={() => {
                                        if (window.confirm('Supprimer ce shot ?')) {
                                            onDelete(shot.id);
                                        }
                                    }}
                                >
                                    ‚úï
                                </button>
                            </div>
                            <div className="shot-details">
                                <div className="detail">
                                    <strong>{shot.dose}g</strong> ‚Üí <strong>{shot.output}g</strong> (1:{shot.ratio.toFixed(1)})
                                </div>
                                <div className="detail">
                                    Mouture: <strong>{shot.grind}</strong>
                                </div>
                                <div className="detail">
                                    Temps: <strong>{shot.time}s</strong>
                                </div>
                                <div className="detail">
                                    PI: <strong>{shot.preinfusion}s</strong>
                                </div>
                                <div className="detail">
                                    √Çge: <strong>{shot.age}j</strong>
                                </div>
                                <div className="detail">
                                    WDT: <strong>{shot.wdt}</strong>
                                </div>
                                <div className="detail">
                                    Channeling: <strong>{shot.channeling}</strong>
                                </div>
                                <div className="detail">
                                    Go√ªt: <strong>{shot.taste}</strong>
                                </div>
                            </div>
                            {shot.notes && (
                                <div style={{ marginTop: '10px', fontSize: '14px', color: '#666', fontStyle: 'italic' }}>
                                    üìù {shot.notes}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            );
        }

        // ========================================
        // AJOUTER UN SHOT
        // ========================================
        function AddShot({ bags, onAdd }) {
            const [formData, setFormData] = useState({
                coffee: 'G√©d√©o',
                roaster: 'L\'Arbre √† Caf√©',
                roast_date: '',
                dose: 18,
                output: 38,
                grind: 7.5,
                time: 30,
                preinfusion: 8,
                wdt: 'non',
                channeling: 'non',
                flow: 'stable',
                taste: '',
                notes: ''
            });

            const activeBags = bags.filter(b => b.status === 'active');

            function handleSubmit(e) {
                e.preventDefault();
                
                const age = formData.roast_date ? 
                    Math.floor((new Date() - new Date(formData.roast_date.split('/').reverse().join('-'))) / (1000 * 60 * 60 * 24)) : 0;
                
                const shot = {
                    date: new Date().toLocaleString('fr-FR'),
                    coffee: formData.coffee,
                    roaster: formData.roaster,
                    roast_date: formData.roast_date,
                    age: age,
                    dose: parseFloat(formData.dose),
                    output: parseFloat(formData.output),
                    ratio: parseFloat((formData.output / formData.dose).toFixed(2)),
                    grind: parseFloat(formData.grind),
                    time: parseInt(formData.time),
                    preinfusion: parseInt(formData.preinfusion),
                    wdt: formData.wdt,
                    channeling: formData.channeling,
                    flow: formData.flow,
                    taste: formData.taste,
                    notes: formData.notes
                };
                
                onAdd(shot);
            }

            return (
                <div className="card">
                    <h2>Nouveau Shot</h2>
                    
                    {activeBags.length > 0 && (
                        <div className="alert alert-info" style={{ marginBottom: '20px' }}>
                            üí° Paquets actifs : <strong>{activeBags.map(b => b.name).join(', ')}</strong>
                        </div>
                    )}
                    
                    <form onSubmit={handleSubmit}>
                        <div className="form-group">
                            <label>Caf√© *</label>
                            <div style={{ display: 'flex', gap: '10px', marginBottom: '10px', flexWrap: 'wrap' }}>
                                <button
                                    type="button"
                                    onClick={() => setFormData({...formData, coffee: 'G√©d√©o', roast_date: ''})}
                                    style={{
                                        padding: '8px 12px',
                                        border: formData.coffee === 'G√©d√©o' ? '3px solid #6f4e37' : '2px solid #e0e0e0',
                                        borderRadius: '8px',
                                        background: 'white',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}
                                >
                                    <img src={COFFEE_LOGOS.gedeo} alt="G√©d√©o" style={{ width: '24px', height: '24px', borderRadius: '50%' }} />
                                    <span>G√©d√©o</span>
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setFormData({...formData, coffee: 'Timan√†', roast_date: ''})}
                                    style={{
                                        padding: '8px 12px',
                                        border: formData.coffee === 'Timan√†' ? '3px solid #6f4e37' : '2px solid #e0e0e0',
                                        borderRadius: '8px',
                                        background: 'white',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}
                                >
                                    <img src={COFFEE_LOGOS.timana} alt="Timan√†" style={{ width: '24px', height: '24px', borderRadius: '50%' }} />
                                    <span>Timan√†</span>
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setFormData({...formData, coffee: '', roast_date: ''})}
                                    style={{
                                        padding: '8px 12px',
                                        border: !formData.coffee || (formData.coffee !== 'G√©d√©o' && formData.coffee !== 'Timan√†') ? '3px solid #6f4e37' : '2px solid #e0e0e0',
                                        borderRadius: '8px',
                                        background: 'white',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}
                                >
                                    <img src={COFFEE_LOGOS.generic} alt="Autre" style={{ width: '24px', height: '24px', borderRadius: '50%' }} />
                                    <span>Autre</span>
                                </button>
                            </div>
                            <input 
                                type="text" 
                                value={formData.coffee}
                                onChange={(e) => setFormData({...formData, coffee: e.target.value})}
                                placeholder="Nom du caf√©"
                                required
                            />
                        </div>

                        <div className="form-group">
                            <label>Torr√©facteur</label>
                            <input 
                                type="text" 
                                value={formData.roaster}
                                onChange={(e) => setFormData({...formData, roaster: e.target.value})}
                            />
                        </div>

                        <div className="form-group">
                            <label>Date torr√©faction (JJ/MM/AAAA)</label>
                            <input 
                                type="text" 
                                placeholder="31/12/2025"
                                value={formData.roast_date}
                                onChange={(e) => setFormData({...formData, roast_date: e.target.value})}
                            />
                        </div>

                        <div className="two-col">
                            <div className="form-group">
                                <label>Dose (g) *</label>
                                <input 
                                    type="number" 
                                    step="0.1"
                                    value={formData.dose}
                                    onChange={(e) => setFormData({...formData, dose: e.target.value})}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>Sortie (g) *</label>
                                <input 
                                    type="number" 
                                    step="0.1"
                                    value={formData.output}
                                    onChange={(e) => setFormData({...formData, output: e.target.value})}
                                    required
                                />
                            </div>
                        </div>

                        <div className="two-col">
                            <div className="form-group">
                                <label>Mouture *</label>
                                <input 
                                    type="number" 
                                    step="0.1"
                                    value={formData.grind}
                                    onChange={(e) => setFormData({...formData, grind: e.target.value})}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>Temps (s) *</label>
                                <input 
                                    type="number"
                                    value={formData.time}
                                    onChange={(e) => setFormData({...formData, time: e.target.value})}
                                    required
                                />
                            </div>
                        </div>

                        <div className="two-col">
                            <div className="form-group">
                                <label>Pr√©infusion (s)</label>
                                <input 
                                    type="number"
                                    value={formData.preinfusion}
                                    onChange={(e) => setFormData({...formData, preinfusion: e.target.value})}
                                />
                            </div>
                            <div className="form-group">
                                <label>WDT</label>
                                <select 
                                    value={formData.wdt}
                                    onChange={(e) => setFormData({...formData, wdt: e.target.value})}
                                >
                                    <option value="non">Non</option>
                                    <option value="l√©ger">L√©ger</option>
                                    <option value="normal">Normal</option>
                                    <option value="profond">Profond</option>
                                </select>
                            </div>
                        </div>

                        <div className="two-col">
                            <div className="form-group">
                                <label>Channeling</label>
                                <select 
                                    value={formData.channeling}
                                    onChange={(e) => setFormData({...formData, channeling: e.target.value})}
                                >
                                    <option value="non">Non</option>
                                    <option value="oui">Oui</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label>D√©bit</label>
                                <select 
                                    value={formData.flow}
                                    onChange={(e) => setFormData({...formData, flow: e.target.value})}
                                >
                                    <option value="rapide">Rapide</option>
                                    <option value="stable">Stable</option>
                                    <option value="lent">Lent</option>
                                </select>
                            </div>
                        </div>

                        <div className="form-group">
                            <label>Go√ªt</label>
                            <input 
                                type="text" 
                                placeholder="tr√®s bon, bon, acide..."
                                value={formData.taste}
                                onChange={(e) => setFormData({...formData, taste: e.target.value})}
                            />
                        </div>

                        <div className="form-group">
                            <label>Notes</label>
                            <textarea 
                                rows="3"
                                placeholder="Observations, ajustements √† tester..."
                                value={formData.notes}
                                onChange={(e) => setFormData({...formData, notes: e.target.value})}
                            />
                        </div>

                        <button type="submit" className="btn btn-primary" style={{ width: '100%' }}>
                            Enregistrer le Shot
                        </button>
                    </form>
                </div>
            );
        }

        // ========================================
        // LISTE DES PAQUETS
        // ========================================
        function BagsList({ bags, onUpdate, onDelete }) {
            if (bags.length === 0) {
                return (
                    <div className="card">
                        <div className="alert alert-info">
                            Aucun paquet enregistr√©. Ajoutez votre premier paquet !
                        </div>
                    </div>
                );
            }

            function calculateAge(roastDate) {
                if (!roastDate) return 0;
                const parts = roastDate.split('/');
                const date = new Date(parts[2], parts[1] - 1, parts[0]);
                return Math.floor((new Date() - date) / (1000 * 60 * 60 * 24));
            }

            return (
                <div className="bag-list">
                    {bags.map(bag => {
                        const age = calculateAge(bag.roast_date);
                        return (
                            <div key={bag.id} className="bag-card">
                                <div className="bag-header">
                                    <div style={{ display: 'flex', alignItems: 'flex-start', gap: '12px' }}>
                                        <img 
                                            src={getCoffeeLogo(bag.name)} 
                                            alt={bag.name}
                                            style={{ width: '48px', height: '48px', borderRadius: '50%', marginTop: '4px' }}
                                        />
                                        <div>
                                            <div className="bag-title">{bag.name}</div>
                                            <div className="bag-info">{bag.roaster} ‚Ä¢ Torr√©fi√© le {bag.roast_date}</div>
                                            <div className="bag-info">√Çge: {age} jours ‚Ä¢ {bag.weight}g</div>
                                            <span className={`bag-status ${bag.status}`}>
                                                {bag.status === 'active' ? '‚úì Actif' : '‚óã Termin√©'}
                                            </span>
                                        </div>
                                    </div>
                                    <div style={{ display: 'flex', gap: '8px' }}>
                                        <button 
                                            className="btn btn-secondary btn-small"
                                            onClick={() => onUpdate(bag.id, { 
                                                status: bag.status === 'active' ? 'finished' : 'active' 
                                            })}
                                        >
                                            {bag.status === 'active' ? 'Terminer' : 'R√©activer'}
                                        </button>
                                        <button 
                                            className="btn btn-danger btn-small"
                                            onClick={() => {
                                                if (window.confirm('Supprimer ce paquet ?')) {
                                                    onDelete(bag.id);
                                                }
                                            }}
                                        >
                                            ‚úï
                                        </button>
                                    </div>
                                </div>
                                {bag.notes && (
                                    <div style={{ marginTop: '10px', fontSize: '14px', color: '#666', fontStyle: 'italic' }}>
                                        üìù {bag.notes}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            );
        }

        // ========================================
        // AJOUTER UN PAQUET
        // ========================================
        function AddBag({ onAdd }) {
            const [formData, setFormData] = useState({
                name: '',
                roaster: 'L\'Arbre √† Caf√©',
                roast_date: '',
                weight: 250,
                notes: '',
                status: 'active'
            });

            function handleSubmit(e) {
                e.preventDefault();
                onAdd(formData);
                
                setFormData({
                    name: '',
                    roaster: 'L\'Arbre √† Caf√©',
                    roast_date: '',
                    weight: 250,
                    notes: '',
                    status: 'active'
                });
            }

            return (
                <div className="card">
                    <h2>Nouveau Paquet</h2>
                    <form onSubmit={handleSubmit}>
                        <div className="form-group">
                            <label>Nom du caf√© *</label>
                            <div style={{ display: 'flex', gap: '10px', marginBottom: '10px', flexWrap: 'wrap' }}>
                                <button
                                    type="button"
                                    onClick={() => setFormData({...formData, name: 'G√©d√©o'})}
                                    style={{
                                        padding: '8px 12px',
                                        border: formData.name === 'G√©d√©o' ? '3px solid #6f4e37' : '2px solid #e0e0e0',
                                        borderRadius: '8px',
                                        background: 'white',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}
                                >
                                    <img src={COFFEE_LOGOS.gedeo} alt="G√©d√©o" style={{ width: '24px', height: '24px', borderRadius: '50%' }} />
                                    <span>G√©d√©o</span>
                                </button>
                                <button
                                    type="button"
                                    onClick={() => setFormData({...formData, name: 'Timan√†'})}
                                    style={{
                                        padding: '8px 12px',
                                        border: formData.name === 'Timan√†' ? '3px solid #6f4e37' : '2px solid #e0e0e0',
                                        borderRadius: '8px',
                                        background: 'white',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        gap: '8px'
                                    }}
                                >
                                    <img src={COFFEE_LOGOS.timana} alt="Timan√†" style={{ width: '24px', height: '24px', borderRadius: '50%' }} />
                                    <span>Timan√†</span>
                                </button>
                            </div>
                            <input 
                                type="text" 
                                placeholder="G√©d√©o, Finca La Folie..."
                                value={formData.name}
                                onChange={(e) => setFormData({...formData, name: e.target.value})}
                                required
                            />
                        </div>

                        <div className="form-group">
                            <label>Torr√©facteur</label>
                            <input 
                                type="text" 
                                value={formData.roaster}
                                onChange={(e) => setFormData({...formData, roaster: e.target.value})}
                            />
                        </div>

                        <div className="two-col">
                            <div className="form-group">
                                <label>Date torr√©faction (JJ/MM/AAAA) *</label>
                                <input 
                                    type="text" 
                                    placeholder="31/12/2025"
                                    value={formData.roast_date}
                                    onChange={(e) => setFormData({...formData, roast_date: e.target.value})}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>Poids (g)</label>
                                <input 
                                    type="number"
                                    value={formData.weight}
                                    onChange={(e) => setFormData({...formData, weight: e.target.value})}
                                />
                            </div>
                        </div>

                        <div className="form-group">
                            <label>Notes</label>
                            <textarea 
                                rows="3"
                                placeholder="Profil aromatique, point de d√©part mouture..."
                                value={formData.notes}
                                onChange={(e) => setFormData({...formData, notes: e.target.value})}
                            />
                        </div>

                        <button type="submit" className="btn btn-primary" style={{ width: '100%' }}>
                            Ajouter le Paquet
                        </button>
                    </form>
                </div>
            );
        }

        // ========================================
        // STATISTIQUES
        // ========================================
        function Stats({ shots, bags }) {
            const [chartInstance, setChartInstance] = useState(null);

            useEffect(() => {
                if (shots.length > 0) {
                    renderChart();
                }
                return () => {
                    if (chartInstance) {
                        chartInstance.destroy();
                    }
                };
            }, [shots]);

            function renderChart() {
                const canvas = document.getElementById('grindChart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                
                if (chartInstance) {
                    chartInstance.destroy();
                }

                const sortedShots = [...shots].sort((a, b) => a.age - b.age);

                const newChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Mouture vs √Çge',
                            data: sortedShots.map(shot => ({
                                x: shot.age,
                                y: shot.grind
                            })),
                            backgroundColor: 'rgba(111, 78, 55, 0.6)',
                            borderColor: 'rgba(111, 78, 55, 1)',
                            borderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '√Çge du caf√© (jours)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Mouture'
                                }
                            }
                        }
                    }
                });

                setChartInstance(newChart);
            }

            if (shots.length === 0) {
                return (
                    <div className="card">
                        <div className="alert alert-info">
                            Pas encore de statistiques. Ajoutez des shots !
                        </div>
                    </div>
                );
            }

            const avgGrind = (shots.reduce((sum, s) => sum + s.grind, 0) / shots.length).toFixed(1);
            const avgTime = Math.round(shots.reduce((sum, s) => sum + s.time, 0) / shots.length);
            const avgRatio = (shots.reduce((sum, s) => sum + s.ratio, 0) / shots.length).toFixed(2);

            return (
                <div>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-value">{shots.length}</div>
                            <div className="stat-label">Shots</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{bags.length}</div>
                            <div className="stat-label">Paquets</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{avgGrind}</div>
                            <div className="stat-label">Mouture moy.</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{avgTime}s</div>
                            <div className="stat-label">Temps moy.</div>
                        </div>
                    </div>

                    <div className="card">
                        <h3>√âvolution Mouture vs √Çge</h3>
                        <div className="chart-container">
                            <canvas id="grindChart"></canvas>
                        </div>
                    </div>
                </div>
            );
        }

        // ========================================
        // PARAM√àTRES
        // ========================================
        function Settings({ onImport, onExport, shotCount }) {
            return (
                <div className="card">
                    <h2>Param√®tres</h2>
                    
                    <div className="alert alert-success">
                        ‚úÖ Vos donn√©es sont synchronis√©es automatiquement entre tous vos appareils via Supabase
                    </div>

                    <div style={{ marginTop: '20px' }}>
                        <h3>Importer des donn√©es CSV</h3>
                        <p style={{ color: '#666', fontSize: '14px', marginBottom: '15px' }}>
                            Importez votre ancien fichier CSV pour r√©cup√©rer vos shots.
                        </p>
                        
                        <div className="file-input-wrapper">
                            <button className="btn btn-secondary">
                                üìÅ Choisir un fichier CSV
                            </button>
                            <input 
                                type="file" 
                                accept=".csv"
                                onChange={onImport}
                            />
                        </div>
                    </div>

                    <div className="import-section">
                        <h3>Exporter les donn√©es</h3>
                        <p style={{ color: '#666', fontSize: '14px', marginBottom: '15px' }}>
                            Exportez vos {shotCount} shots en CSV pour backup.
                        </p>
                        
                        <button 
                            className="btn btn-primary"
                            onClick={onExport}
                            disabled={shotCount === 0}
                        >
                            üì• T√©l√©charger CSV
                        </button>
                    </div>
                </div>
            );
        }

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EspressoTracker />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espresso Tracker</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab.active {
            color: #6f4e37;
            border-bottom-color: #6f4e37;
            font-weight: 600;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #6f4e37;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #6f4e37;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a3d2a;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .shot-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .shot-card {
            background: #fafafa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .shot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .shot-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .shot-date {
            font-size: 14px;
            color: #888;
        }
        
        .shot-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        
        .detail {
            color: #666;
        }
        
        .detail strong {
            color: #333;
        }
        
        .import-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #6f4e37 0%, #5a3d2a 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }
        
        .alert-success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }
        
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        @media (max-width: 600px) {
            .two-col {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Composant principal
        function EspressoTracker() {
            const [activeTab, setActiveTab] = useState('shots');
            const [shots, setShots] = useState([]);
            const [bags, setBags] = useState([]);
            const [loading, setLoading] = useState(true);
            const [importMessage, setImportMessage] = useState('');

            // Charger les donn√©es au d√©marrage
            useEffect(() => {
                loadData();
            }, []);

            async function loadData() {
                try {
                    setLoading(true);
                    
                    // Charger les shots
                    const shotsData = await window.storage.get('espresso-shots', true);
                    if (shotsData && shotsData.value) {
                        setShots(JSON.parse(shotsData.value));
                    }
                    
                    // Charger les paquets
                    const bagsData = await window.storage.get('espresso-bags', true);
                    if (bagsData && bagsData.value) {
                        setBags(JSON.parse(bagsData.value));
                    }
                } catch (error) {
                    console.log('Premi√®re utilisation ou donn√©es vides');
                } finally {
                    setLoading(false);
                }
            }

            async function saveShots(newShots) {
                try {
                    await window.storage.set('espresso-shots', JSON.stringify(newShots), true);
                    setShots(newShots);
                } catch (error) {
                    console.error('Erreur sauvegarde shots:', error);
                }
            }

            async function saveBags(newBags) {
                try {
                    await window.storage.set('espresso-bags', JSON.stringify(newBags), true);
                    setBags(newBags);
                } catch (error) {
                    console.error('Erreur sauvegarde bags:', error);
                }
            }

            function handleImportCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n').filter(l => l.trim());
                        const headers = lines[0].split(',');
                        
                        const importedShots = [];
                        
                        for (let i = 1; i < lines.length; i++) {
                            const values = lines[i].split(',');
                            if (values.length < 10) continue;
                            
                            const shot = {
                                id: Date.now() + i,
                                date: values[0].trim(),
                                coffee: values[1].trim(),
                                roaster: values[2].trim(),
                                roastDate: values[3].trim(),
                                age: parseInt(values[4]) || 0,
                                dose: parseFloat(values[5]) || 18,
                                output: parseFloat(values[6]) || 36,
                                ratio: parseFloat(values[7]) || 2,
                                grind: parseFloat(values[8]) || 7.5,
                                time: parseInt(values[9]) || 0,
                                preinfusion: parseInt(values[10]) || 0,
                                wdt: values[11]?.trim() || 'non',
                                channeling: values[12]?.trim() || 'non',
                                flow: values[13]?.trim() || 'stable',
                                taste: values[14]?.trim() || '',
                                notes: values[15]?.trim() || ''
                            };
                            
                            importedShots.push(shot);
                        }
                        
                        await saveShots(importedShots);
                        setImportMessage(`‚úÖ ${importedShots.length} shots import√©s avec succ√®s !`);
                        setTimeout(() => setImportMessage(''), 5000);
                    } catch (error) {
                        setImportMessage('‚ùå Erreur lors de l\'import');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            }

            function exportCSV() {
                const headers = ['Date shot', 'Caf√©', 'Torr√©facteur', 'Date torr√©faction', '√Çge (jours)', 
                               'Dose (g)', 'Sortie (g)', 'Ratio', 'Mouture', 'Temps (s)', 'Pr√©infusion (s)',
                               'WDT', 'Channeling', 'D√©bit', 'Go√ªt', 'Notes'];
                
                const rows = shots.map(shot => [
                    shot.date,
                    shot.coffee,
                    shot.roaster,
                    shot.roastDate,
                    shot.age,
                    shot.dose,
                    shot.output,
                    shot.ratio,
                    shot.grind,
                    shot.time,
                    shot.preinfusion,
                    shot.wdt,
                    shot.channeling,
                    shot.flow,
                    shot.taste,
                    shot.notes
                ].join(','));
                
                const csv = [headers.join(','), ...rows].join('\n');
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `espresso_data_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
            }

            if (loading) {
                return <div className="container"><h1>Chargement...</h1></div>;
            }

            return (
                <div className="container">
                    <h1>‚òï Espresso Tracker</h1>
                    
                    <div className="tabs">
                        <button 
                            className={`tab ${activeTab === 'shots' ? 'active' : ''}`}
                            onClick={() => setActiveTab('shots')}
                        >
                            Shots
                        </button>
                        <button 
                            className={`tab ${activeTab === 'add' ? 'active' : ''}`}
                            onClick={() => setActiveTab('add')}
                        >
                            Nouveau Shot
                        </button>
                        <button 
                            className={`tab ${activeTab === 'stats' ? 'active' : ''}`}
                            onClick={() => setActiveTab('stats')}
                        >
                            Stats
                        </button>
                        <button 
                            className={`tab ${activeTab === 'settings' ? 'active' : ''}`}
                            onClick={() => setActiveTab('settings')}
                        >
                            Import/Export
                        </button>
                    </div>

                    {activeTab === 'shots' && (
                        <ShotsList shots={shots} onDelete={(id) => {
                            saveShots(shots.filter(s => s.id !== id));
                        }} />
                    )}

                    {activeTab === 'add' && (
                        <AddShot bags={bags} onAdd={(shot) => {
                            saveShots([shot, ...shots]);
                            setActiveTab('shots');
                        }} />
                    )}

                    {activeTab === 'stats' && (
                        <Stats shots={shots} />
                    )}

                    {activeTab === 'settings' && (
                        <Settings 
                            onImport={handleImportCSV}
                            onExport={exportCSV}
                            importMessage={importMessage}
                            shotCount={shots.length}
                        />
                    )}
                </div>
            );
        }

        // Composant Liste des shots
        function ShotsList({ shots, onDelete }) {
            if (shots.length === 0) {
                return (
                    <div className="card">
                        <div className="alert alert-info">
                            Aucun shot enregistr√©. Importez vos donn√©es ou ajoutez un nouveau shot !
                        </div>
                    </div>
                );
            }

            return (
                <div className="shot-list">
                    {shots.map(shot => (
                        <div key={shot.id} className="shot-card">
                            <div className="shot-header">
                                <div>
                                    <div className="shot-title">{shot.coffee}</div>
                                    <div className="shot-date">{shot.date}</div>
                                </div>
                                <button 
                                    className="btn btn-secondary btn-small"
                                    onClick={() => onDelete(shot.id)}
                                >
                                    Supprimer
                                </button>
                            </div>
                            <div className="shot-details">
                                <div className="detail">
                                    <strong>{shot.dose}g</strong> ‚Üí <strong>{shot.output}g</strong> (1:{shot.ratio.toFixed(1)})
                                </div>
                                <div className="detail">
                                    Mouture: <strong>{shot.grind}</strong>
                                </div>
                                <div className="detail">
                                    Temps: <strong>{shot.time}s</strong>
                                </div>
                                <div className="detail">
                                    PI: <strong>{shot.preinfusion}s</strong>
                                </div>
                                <div className="detail">
                                    √Çge: <strong>{shot.age}j</strong>
                                </div>
                                <div className="detail">
                                    WDT: <strong>{shot.wdt}</strong>
                                </div>
                                <div className="detail">
                                    Channeling: <strong>{shot.channeling}</strong>
                                </div>
                                <div className="detail">
                                    Go√ªt: <strong>{shot.taste}</strong>
                                </div>
                            </div>
                            {shot.notes && (
                                <div style={{ marginTop: '10px', fontSize: '14px', color: '#666' }}>
                                    üìù {shot.notes}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            );
        }

        // Composant Ajouter un shot
        function AddShot({ bags, onAdd }) {
            const [formData, setFormData] = useState({
                coffee: 'G√©d√©o',
                roaster: 'L\'arbre √† caf√©',
                roastDate: '',
                dose: 18,
                output: 38,
                grind: 7.5,
                time: 30,
                preinfusion: 8,
                wdt: 'non',
                channeling: 'non',
                flow: 'stable',
                taste: '',
                notes: ''
            });

            function handleSubmit(e) {
                e.preventDefault();
                
                const age = formData.roastDate ? 
                    Math.floor((new Date() - new Date(formData.roastDate.split('/').reverse().join('-'))) / (1000 * 60 * 60 * 24)) : 0;
                
                const shot = {
                    id: Date.now(),
                    date: new Date().toLocaleString('fr-FR'),
                    coffee: formData.coffee,
                    roaster: formData.roaster,
                    roastDate: formData.roastDate,
                    age: age,
                    dose: parseFloat(formData.dose),
                    output: parseFloat(formData.output),
                    ratio: parseFloat((formData.output / formData.dose).toFixed(2)),
                    grind: parseFloat(formData.grind),
                    time: parseInt(formData.time),
                    preinfusion: parseInt(formData.preinfusion),
                    wdt: formData.wdt,
                    channeling: formData.channeling,
                    flow: formData.flow,
                    taste: formData.taste,
                    notes: formData.notes
                };
                
                onAdd(shot);
            }

            return (
                <div className="card">
                    <h2 style={{ marginBottom: '20px', color: '#2c3e50' }}>Nouveau Shot</h2>
                    <form onSubmit={handleSubmit}>
                        <div className="two-col">
                            <div className="form-group">
                                <label>Caf√©</label>
                                <input 
                                    type="text" 
                                    value={formData.coffee}
                                    onChange={(e) => setFormData({...formData, coffee: e.target.value})}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>Torr√©facteur</label>
                                <input 
                                    type="text" 
                                    value={formData.roaster}
                                    onChange={(e) => setFormData({...formData, roaster: e.target.value})}
                                />
                            </div>
                        </div>

                        <div className="form-group">
                            <label>Date torr√©faction (JJ/MM/AAAA)</label>
                            <input 
                                type="text" 
                                placeholder="31/12/2025"
                                value={formData.roastDate}
                                onChange={(e) => setFormData({...formData, roastDate: e.target.value})}
                            />
                        </div>

                        <div className="two-col">
                            <div className="form-group">
                                <label>Dose (g)</label>
                                <input 
                                    type="number" 
                                    step="0.1"
                                    value={formData.dose}
                                    onChange={(e) => setFormData({...formData, dose: e.target.value})}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>Sortie (g)</label>
                                <input 
                                    type="number" 
                                    step="0.1"
                                    value={formData.output}
                                    onChange={(e) => setFormData({...formData, output: e.target.value})}
                                    required
                                />
                            </div>
                        </div>

                        <div className="two-col">
                            <div className="form-group">
                                <label>Mouture</label>
                                <input 
                                    type="number" 
                                    step="0.1"
                                    value={formData.grind}
                                    onChange={(e) => setFormData({...formData, grind: e.target.value})}
                                    required
                                />
                            </div>
                            <div className="form-group">
                                <label>Temps (s)</label>
                                <input 
                                    type="number"
                                    value={formData.time}
                                    onChange={(e) => setFormData({...formData, time: e.target.value})}
                                    required
                                />
                            </div>
                        </div>

                        <div className="two-col">
                            <div className="form-group">
                                <label>Pr√©infusion (s)</label>
                                <input 
                                    type="number"
                                    value={formData.preinfusion}
                                    onChange={(e) => setFormData({...formData, preinfusion: e.target.value})}
                                />
                            </div>
                            <div className="form-group">
                                <label>WDT</label>
                                <select 
                                    value={formData.wdt}
                                    onChange={(e) => setFormData({...formData, wdt: e.target.value})}
                                >
                                    <option value="non">Non</option>
                                    <option value="l√©ger">L√©ger</option>
                                    <option value="normal">Normal</option>
                                    <option value="profond">Profond</option>
                                </select>
                            </div>
                        </div>

                        <div className="two-col">
                            <div className="form-group">
                                <label>Channeling</label>
                                <select 
                                    value={formData.channeling}
                                    onChange={(e) => setFormData({...formData, channeling: e.target.value})}
                                >
                                    <option value="non">Non</option>
                                    <option value="oui">Oui</option>
                                </select>
                            </div>
                            <div className="form-group">
                                <label>D√©bit</label>
                                <select 
                                    value={formData.flow}
                                    onChange={(e) => setFormData({...formData, flow: e.target.value})}
                                >
                                    <option value="rapide">Rapide</option>
                                    <option value="stable">Stable</option>
                                    <option value="lent">Lent</option>
                                </select>
                            </div>
                        </div>

                        <div className="form-group">
                            <label>Go√ªt</label>
                            <input 
                                type="text" 
                                placeholder="tr√®s bon, bon, acide..."
                                value={formData.taste}
                                onChange={(e) => setFormData({...formData, taste: e.target.value})}
                            />
                        </div>

                        <div className="form-group">
                            <label>Notes</label>
                            <textarea 
                                rows="3"
                                placeholder="Observations..."
                                value={formData.notes}
                                onChange={(e) => setFormData({...formData, notes: e.target.value})}
                            />
                        </div>

                        <button type="submit" className="btn btn-primary" style={{ width: '100%' }}>
                            Enregistrer le Shot
                        </button>
                    </form>
                </div>
            );
        }

        // Composant Statistiques
        function Stats({ shots }) {
            const [chartInstance, setChartInstance] = useState(null);

            useEffect(() => {
                if (shots.length > 0) {
                    renderChart();
                }
                return () => {
                    if (chartInstance) {
                        chartInstance.destroy();
                    }
                };
            }, [shots]);

            function renderChart() {
                const canvas = document.getElementById('grindChart');
                if (!canvas) return;

                const ctx = canvas.getContext('2d');
                
                if (chartInstance) {
                    chartInstance.destroy();
                }

                // Trier les shots par √¢ge
                const sortedShots = [...shots].sort((a, b) => a.age - b.age);

                const newChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'Mouture vs √Çge',
                            data: sortedShots.map(shot => ({
                                x: shot.age,
                                y: shot.grind
                            })),
                            backgroundColor: 'rgba(111, 78, 55, 0.6)',
                            borderColor: 'rgba(111, 78, 55, 1)',
                            borderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '√Çge du caf√© (jours)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Mouture'
                                }
                            }
                        }
                    }
                });

                setChartInstance(newChart);
            }

            if (shots.length === 0) {
                return (
                    <div className="card">
                        <div className="alert alert-info">
                            Pas encore de statistiques. Ajoutez des shots !
                        </div>
                    </div>
                );
            }

            const avgGrind = (shots.reduce((sum, s) => sum + s.grind, 0) / shots.length).toFixed(1);
            const avgTime = Math.round(shots.reduce((sum, s) => sum + s.time, 0) / shots.length);
            const avgRatio = (shots.reduce((sum, s) => sum + s.ratio, 0) / shots.length).toFixed(2);

            return (
                <div>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <div className="stat-value">{shots.length}</div>
                            <div className="stat-label">Shots</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{avgGrind}</div>
                            <div className="stat-label">Mouture moy.</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{avgTime}s</div>
                            <div className="stat-label">Temps moy.</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">1:{avgRatio}</div>
                            <div className="stat-label">Ratio moy.</div>
                        </div>
                    </div>

                    <div className="card">
                        <h3 style={{ marginBottom: '15px' }}>√âvolution Mouture vs √Çge</h3>
                        <div className="chart-container">
                            <canvas id="grindChart"></canvas>
                        </div>
                    </div>
                </div>
            );
        }

        // Composant Settings
        function Settings({ onImport, onExport, importMessage, shotCount }) {
            return (
                <div className="card">
                    <h2 style={{ marginBottom: '20px', color: '#2c3e50' }}>Import / Export</h2>
                    
                    {importMessage && (
                        <div className="alert alert-success">
                            {importMessage}
                        </div>
                    )}

                    <div className="alert alert-info">
                        üí° Vos donn√©es sont synchronis√©es automatiquement entre tous vos appareils (t√©l√©phone, ordinateur, etc.)
                    </div>

                    <div style={{ marginTop: '20px' }}>
                        <h3 style={{ marginBottom: '10px' }}>Importer des donn√©es CSV</h3>
                        <p style={{ color: '#666', fontSize: '14px', marginBottom: '15px' }}>
                            Importez votre fichier CSV existant pour r√©cup√©rer vos shots.
                        </p>
                        
                        <div className="file-input-wrapper">
                            <button className="btn btn-secondary">
                                üìÅ Choisir un fichier CSV
                            </button>
                            <input 
                                type="file" 
                                accept=".csv"
                                onChange={onImport}
                            />
                        </div>
                    </div>

                    <div className="import-section">
                        <h3 style={{ marginBottom: '10px' }}>Exporter les donn√©es</h3>
                        <p style={{ color: '#666', fontSize: '14px', marginBottom: '15px' }}>
                            Exportez vos {shotCount} shots en CSV pour backup ou analyse.
                        </p>
                        
                        <button 
                            className="btn btn-primary"
                            onClick={onExport}
                            disabled={shotCount === 0}
                        >
                            üì• T√©l√©charger CSV
                        </button>
                    </div>
                </div>
            );
        }

        // Render de l'app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<EspressoTracker />);
    </script>
</body>
</html>

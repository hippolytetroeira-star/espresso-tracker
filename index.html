<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚òï Espresso Tracker (simple)</title>
    <style>
        /* Tous tes styles sont d√©j√† ici, je les garde √† l'identique */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f8f5f0; padding: 0; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #8B4513 0%, #6B3410 100%); color: white; padding: 25px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
        .header h1 { font-size: 28px; font-weight: 700; }
        .container { max-width: 900px; margin: 0 auto; padding: 30px 20px; }
        .tabs { display: flex; gap: 15px; margin-bottom: 30px; justify-content: center; }
        .tab { padding: 15px 35px; background: white; border: 2px solid #e0d5c7; border-radius: 12px; cursor: pointer; font-size: 17px; font-weight: 600; color: #666; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tab:hover { border-color: #8B4513; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(139, 69, 19, 0.15); }
        .tab.active { background: linear-gradient(135deg, #8B4513 0%, #6B3410 100%); color: white; border-color: #8B4513; }
        .section { background: white; border-radius: 16px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { color: #8B4513; font-size: 24px; margin-bottom: 25px; font-weight: 700; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 600; font-size: 15px; }
        input, select, textarea { width: 100%; padding: 14px 16px; border: 2px solid #e0d5c7; border-radius: 10px; font-size: 16px; background: #fafaf8; transition: all 0.2s; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #8B4513; background: white; box-shadow: 0 0 0 3px rgba(139, 69, 19, 0.1); }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn { padding: 16px 32px; border: none; border-radius: 12px; font-size: 17px; font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: linear-gradient(135deg, #8B4513 0%, #6B3410 100%); color: white; width: 100%; box-shadow: 0 4px 15px rgba(139, 69, 19, 0.3); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 69, 19, 0.4); }
        .btn-secondary { background: #f0e6d9; color: #8B4513; font-weight: 600; padding: 12px 24px; font-size: 15px; }
        .btn-small { padding: 10px 20px; font-size: 14px; }
        .btn-danger { background: #dc3545; color: white; }
        .shot-item { background: #fafaf8; border: 2px solid #e8ddd0; border-radius: 14px; padding: 25px; margin-bottom: 20px; transition: all 0.3s; }
        .shot-item:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); border-color: #8B4513; }
        .shot-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e8ddd0; }
        .shot-title { font-size: 20px; font-weight: 700; color: #8B4513; }
        .shot-date { font-size: 14px; color: #888; margin-top: 5px; }
        .shot-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 18px; margin-top: 15px; }
        .detail { background: white; padding: 14px; border-radius: 10px; font-size: 15px; color: #555; }
        .detail strong { color: #8B4513; font-weight: 700; display: block; margin-bottom: 5px; }
        .bag-item { background: #fafaf8; border: 2px solid #e8ddd0; border-radius: 14px; padding: 25px; margin-bottom: 20px; background-size: cover; background-position: center; position: relative; }
        .bag-item::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(250, 250, 248, 0.85); border-radius: 14px; z-index: 0; }
        .bag-item > * { position: relative; z-index: 1; }
        .bag-header { display: flex; justify-content: space-between; align-items: center; }
        .bag-title { font-size: 20px; font-weight: 700; color: #8B4513; }
        .bag-info { margin-top: 12px; font-size: 15px; color: #666; line-height: 1.6; }
        .bag-status { display: inline-block; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; margin-top: 10px; }
        .bag-status.active { background: #4caf50; color: white; }
        .bag-status.finished { background: #9e9e9e; color: white; }
        .alert { padding: 18px 22px; border-radius: 12px; margin-bottom: 25px; font-weight: 500; font-size: 15px; }
        .alert-success { background: #d4edda; color: #155724; border-left: 5px solid #28a745; }
        .alert-error { background: #f8d7da; color: #721c24; border-left: 5px solid #dc3545; }
        .file-input-wrapper { position: relative; display: inline-block; }
        .file-input-wrapper input[type=file] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .actions { display: flex; gap: 12px; margin-top: 25px; }
        @media (max-width: 600px) { .row { grid-template-columns: 1fr; } .container { padding: 20px 15px; } .tabs { flex-direction: column; gap: 10px; } .tab { padding: 12px 20px; } }
    </style>
    <!-- Chargement de Supabase (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="header">
        <h1>‚òï Espresso Tracker</h1>
    </div>
    <div id="app" class="container">
        <!-- Le contenu sera g√©n√©r√© ici par JavaScript -->
        <div style="text-align: center; padding: 60px; color: #8B4513;">‚è≥ Chargement...</div>
    </div>

    <script>
        // ---------- 1. CONFIG SUPABASE (remplace avec TES cl√©s) ----------
        const SUPABASE_URL = 'https://duzxzqmjkovrsfwhdyml.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1enh6cW1qa292cnNmd2hkeW1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NjAzMzYsImV4cCI6MjA4NjMzNjMzNn0.hRUDEbr9yhd_R1Q0lLVYYppnht5tUAd5TtE9kanzvos';

        // Initialisation Supabase (version CDN)
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ---------- 2. DONN√âES GLOBALES ----------
        let currentTab = 'shots'; // shots, bags, settings
        let shots = [];
        let bags = [];
        let message = null;

        // R√©f√©rence √† l'√©l√©ment #app
        const appEl = document.getElementById('app');

        // ---------- 3. FONCTIONS UTILITAIRES ----------
        function showMessage(type, text) {
            message = { type, text };
            setTimeout(() => { message = null; render(); }, 4000);
            render();
        }

        // Logos et images (reprise de ton code)
        const LOGOS = {
            timana: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAACbUlEQVR4nO2bPVLDMBSEVxnOkQ5OQUtDTkBNmYaOM9DRUKbmBlSUnIKSjlOYgiiRZcnSk/WzzmgbMkNG8n5vnyx7IoW6GgTfVcWuouIkEsMhFbnWEoN6TQ/vN9GDqIfv2X8Lrmd+nlwDwWFcYjgkD5DF158DQFHjtnKDWArgZL6kaZ8sGEleUgGMqt7CvJYjESJPKQDOVd8f/j/cviQMk1epadgI55maB4CvZ+Ew+WWlMPr2KwHgNk+kFAixAMLmCVIAyCHEAIiv/AohhADQx96nWAhzANLMk6QAiIMQbIG1Vd5WaI/iAzAAC8wTpQAYQZikwAUgzyMsGQRDI3/eFlh79G35WsEGsCz6tshS4GoF6Vb44mQCyPn66iyyFBgaAEcCLq33bdlrQZ0W4E3B6bk57+LnE8F7Ay39/qAvglVnI2yFngDU6n8tkhTou0FPQJNZSVIAtEwACYTeAk1nJ0jBVesL2P1+Npx921ugKYDd9V3L6QE0BMBgHmi9CBJog+MjsXp7rDYpQ/U/nrYAegLqA2CovqmegOPfKusAS/V1/wNQ1RLAYt7WBEDNu0ELGdUHMAZQ7HfDpNVXQF8EJwCyL4ZM1TcXP/3Bm4BLWwvs3tdyAci2FjBV39DIny8Bi1uBybwr+lrBRXDtreCLvtYcgBMtKQSW6lvmna0dSkAyhNaKMQ/E7QNEEBiqH2seiN8IRUFYm3lAthOkbwepeUC+FfZCaF39FPOiL1oanxnaH5oBcNzmRJ5SH4YUCFrCUXVxQYucG7x//ckwrFuejU2zc4OmioLIbTzbAA55f3EqARLYwlKeHXaJ/vT4H4+IseLBtt/JAAAAAElFTkSuQmCC',
            gedeo: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAACcUlEQVR4nO2bvU7DMBSFTyo2dgZmNhaeAYmZHfYO3XkKdiTYeQDmCt6CjZWFvXNY6shx7NjX8c9J5bNQidbO+e65jhMlHcqqF3y3y3YUBSeRGPYpy7HmGNRp+vb9EDzI1+P53L+THXdKABPjEsM+OYAsPv4UALIaN5UaxFIAg/mcpl0yYER5iQUwqnoN80qWRIg8xQAYzG/3OwDAz99zxDBpFZuGjXCeiXkAuLp4Eg6TXkYKg0+/EgBW80yKgRAKwGueIQWAHEIIgODKrxGCDwB97F0KhTAHIMo8SwqAMAjeFlhb5U359iguAD0Qb54pBcAIwiQFNgBJLmHZIGga+XO2wNqjb8rVCiaARdE3xZYCWytIt8InJx1AyttXg9hSoKkHLAk4td43Za4FRVqAOAXDdXPSxc8lhvsGSur+QVsES07G2AotASjU/0osKVBng5aAGpOypAComAAWCK0Fak7OkIKz2gfwefNQbe4OrQXqAni9/K05PYCKABjMA60FsMHxkvjt7qXYpAzV764/ALQElAfAUH1dLQHHv0XWAZbqq/4H0BVLAIt5UxMAJc8GNaRVH8AYQLbnhkmr3wFtEZwASL4YMlVfX/zUB2cCTm0tMHtfyQYg2VrAVH1NI3+uBCxuBSbztugreRfBtbeCK/pKcwAGWlIILNU3zFtb25eAaAi1FWIeCNsHiCAwVD/UPBC+EQqCsDbzgGwnSN8OUvOAfCvshFC7+jHmRV80NHqibLvfVQNgOc1lf2dI1wCi/75fOJRcsVVf/CNDk+cLc8JwbGyqvTeoKyuI1MaTDWCR84lTCRDPFpby3WGb6N8e/wdHGbWdc2XBIwAAAABJRU5ErkJggg==',
            generic: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAACdUlEQVR4nO2bP07DMBjFXypuwYbETTgDExIDOwsLW8XWhYWdoRITZ0Bi4QLMSEyUiTuEpY4cx679Of7zUvktVKK1837f+xwnSjqUVS/4bpftKApOIjHsU5ZjzTGo0/Tb60vwIBeXV4f+ney4UwKYGJcY9skBZPbxpwCQ1bip1CDmAhjM5zTtkgEjykssgFHVa5hXsiRC5CkGwGB+u1kDAE7PziOGSavYNKyE80zMA8Du+0s4THoZKQw+/UoAWM0zKQZCKACveYYUAHIIIQCCK79ECD4A9LF3KRTCIQBR5llSAIRB8LbA0ipvyrdHcQHogXjzTCkARhAmKbABSHIJywZB08ifswWWHn1TrlYwAcyKvim2FNhaQboVPjrpAFLevhrElgJNPWBJwLH1vilzLSjSAsQpGK6bky5+LjHcN1BS9w/aIlhyMsZWaAlAof5XYkmBOhu0BNSYlCUFQMUEsEBoLVBzcoYUnNQ+gM+P96rztxaoOfnf70/N6QFUBMBgHmgtgBX2l8TX9w/FJmWo/t3TM4CWgPIAGKqvqyVg/7fIOsBSfdX/ALpiCWAxb2oCoOTZoIa06gMYA8j23DBp9TugLYITAMkXQ6bq64uf+uBMwLGtBWbvK9kAJFsLmKqvaeTPlYDZrcBk3hZ9Je8iuPRWcEVf6RCAgZYUAkv1DfPW1vYlIBpCbYWYB8L2ASIIDNUPNQ+Eb4SCICzNPCDbCdK3g9Q8IN8KOyHUrn6MedEXDY2eKNtu1tUAWE5z2d8Z0jWAeLy9mTmUXLFVn/0jQ5PnC3PCcGxsqr03qCsriNTGkw1gkfOJUwkQzxaW8t1hm+jfHv8HiQrra/56lPwAAAAASUVORK5CYII='
        };

        const PACKAGE_IMAGES = {
            gedeo: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAMwAzAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAGpAlgDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD3+iiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//2Q==',
            timana: 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAMwAzAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAGpAlgDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD3+iiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigAooooAKKKKACiiigD//2Q=='
        };

        function getLogo(name) {
            if (!name) return LOGOS.generic;
            const n = name.toLowerCase();
            if (n.includes('timana') || n.includes('timan√†')) return LOGOS.timana;
            if (n.includes('gedeo') || n.includes('g√©d√©o')) return LOGOS.gedeo;
            return LOGOS.generic;
        }

        function getPackageImage(name) {
            if (!name) return null;
            const n = name.toLowerCase();
            if (n.includes('timana') || n.includes('timan√†')) return PACKAGE_IMAGES.timana;
            if (n.includes('gedeo') || n.includes('g√©d√©o')) return PACKAGE_IMAGES.gedeo;
            return null;
        }

        // ---------- 4. CHARGEMENT DES DONN√âES ----------
        async function loadData() {
            try {
                const { data: s } = await supabase.from('shots').select('*').order('created_at', { ascending: false });
                const { data: b } = await supabase.from('bags').select('*').order('created_at', { ascending: false });
                shots = s || [];
                bags = b || [];
            } catch (e) {
                console.error(e);
                showMessage('error', '‚ùå Erreur de chargement Supabase');
            }
            render();
        }

        // ---------- 5. FONCTIONS CRUD ----------
        async function addShot(event) {
            event.preventDefault();
            const form = event.target;
            const selectedBag = bags.find(b => b.id.toString() === form.bag_id.value);
            const age = selectedBag && selectedBag.roast_date ? 
                Math.floor((new Date() - new Date(selectedBag.roast_date.split('/').reverse().join('-'))) / 86400000) : 0;

            const shot = {
                date: new Date().toLocaleString('fr-FR'),
                coffee: form.coffee.value || (selectedBag ? selectedBag.name : ''),
                roaster: selectedBag ? selectedBag.roaster : "L'Arbre √† Caf√©",
                roast_date: selectedBag ? selectedBag.roast_date : '',
                age,
                dose: parseFloat(form.dose.value),
                output: parseFloat(form.output.value),
                ratio: parseFloat((form.output.value / form.dose.value).toFixed(2)),
                grind: parseFloat(form.grind.value),
                time: parseInt(form.time.value),
                preinfusion: parseInt(form.preinfusion.value),
                wdt: form.wdt.value,
                channeling: form.channeling.value,
                flow: form.flow.value,
                taste: form.taste.value,
                notes: form.notes.value
            };

            const { data } = await supabase.from('shots').insert([shot]).select();
            shots = [data[0], ...shots];
            showMessage('success', '‚úÖ Shot enregistr√© !');
            form.reset();
            // Remettre les valeurs par d√©faut
            form.dose.value = 18;
            form.output.value = 38;
            form.grind.value = 7.5;
            form.time.value = 30;
            form.preinfusion.value = 8;
            render();
        }

        async function deleteShot(id) {
            if (!confirm('Supprimer ce shot ?')) return;
            await supabase.from('shots').delete().eq('id', id);
            shots = shots.filter(s => s.id !== id);
            render();
        }

        async function addBag(event) {
            event.preventDefault();
            const form = event.target;
            const bag = {
                name: form.name.value,
                roaster: form.roaster.value,
                roast_date: form.roast_date.value,
                weight: parseInt(form.weight.value),
                notes: form.notes.value,
                status: 'active'
            };
            const { data } = await supabase.from('bags').insert([bag]).select();
            bags = [data[0], ...bags];
            showMessage('success', '‚úÖ Paquet ajout√© !');
            form.reset();
            render();
        }

        async function toggleBag(id, status) {
            const newStatus = status === 'active' ? 'finished' : 'active';
            await supabase.from('bags').update({ status: newStatus }).eq('id', id);
            bags = bags.map(b => b.id === id ? { ...b, status: newStatus } : b);
            render();
        }

        async function deleteBag(id) {
            if (!confirm('Supprimer ce paquet ?')) return;
            await supabase.from('bags').delete().eq('id', id);
            bags = bags.filter(b => b.id !== id);
            render();
        }

        async function importCSV(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const lines = ev.target.result.split('\n').filter(l => l.trim());
                    const data = [];
                    for (let i = 1; i < lines.length; i++) {
                        const v = lines[i].split(',');
                        if (v.length < 10) continue;
                        data.push({
                            date: v[0].trim(),
                            coffee: v[1].trim(),
                            roaster: v[2].trim(),
                            roast_date: v[3].trim(),
                            age: parseInt(v[4]) || 0,
                            dose: parseFloat(v[5]) || 18,
                            output: parseFloat(v[6]) || 36,
                            ratio: parseFloat(v[7]) || 2,
                            grind: parseFloat(v[8]) || 7.5,
                            time: parseInt(v[9]) || 0,
                            preinfusion: parseInt(v[10]) || 0,
                            wdt: v[11]?.trim() || 'non',
                            channeling: v[12]?.trim() || 'non',
                            flow: v[13]?.trim() || 'stable',
                            taste: v[14]?.trim() || '',
                            notes: v[15]?.trim() || ''
                        });
                    }
                    await supabase.from('shots').insert(data);
                    await loadData();
                    showMessage('success', `‚úÖ ${data.length} shots import√©s !`);
                } catch (e) {
                    showMessage('error', '‚ùå ' + e.message);
                }
            };
            reader.readAsText(file);
        }

        function exportCSV() {
            const h = ['Date shot','Caf√©','Torr√©facteur','Date torr√©faction','√Çge (jours)','Dose (g)','Sortie (g)','Ratio','Mouture','Temps (s)','Pr√©infusion (s)','WDT','Channeling','D√©bit','Go√ªt','Notes'];
            const rows = shots.map(s => [s.date,s.coffee,s.roaster,s.roast_date,s.age,s.dose,s.output,s.ratio,s.grind,s.time,s.preinfusion,s.wdt,s.channeling,s.flow,s.taste,s.notes].join(','));
            const csv = [h.join(','), ...rows].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `espresso_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }

        // ---------- 6. RENDU DE L'INTERFACE (Fonction qui g√©n√®re le HTML) ----------
        function render() {
            const activeBags = bags.filter(b => b.status === 'active');

            let html = `
                <div class="tabs">
                    <button class="tab ${currentTab === 'shots' ? 'active' : ''}" onclick="setTab('shots')">‚òï Shots</button>
                    <button class="tab ${currentTab === 'bags' ? 'active' : ''}" onclick="setTab('bags')">üì¶ Paquets</button>
                    <button class="tab ${currentTab === 'settings' ? 'active' : ''}" onclick="setTab('settings')">‚öôÔ∏è Param√®tres</button>
                </div>
            `;

            if (message) {
                html += `<div class="alert alert-${message.type}">${message.text}</div>`;
            }

            // ---------- ONGLET SHOTS ----------
            if (currentTab === 'shots') {
                html += `
                    <div class="section">
                        <h2>+ Nouveau Shot</h2>
                        <form id="form-shot" onsubmit="event.preventDefault(); addShot(event)">
                            <div class="form-group">
                                <label>Paquet actif</label>
                                <select name="bag_id">
                                    <option value="">-- Choisir un paquet --</option>
                                    ${activeBags.map(b => `<option value="${b.id}">${b.name} (${b.roaster})</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Caf√© (optionnel si paquet s√©lectionn√©)</label>
                                <input type="text" name="coffee" placeholder="Nom du caf√©">
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <label>Dose (g)</label>
                                    <input type="number" step="0.1" name="dose" value="18" required>
                                </div>
                                <div class="form-group">
                                    <label>Sortie (g)</label>
                                    <input type="number" step="0.1" name="output" value="38" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <label>Mouture</label>
                                    <input type="number" step="0.1" name="grind" value="7.5" required>
                                </div>
                                <div class="form-group">
                                    <label>Temps (s)</label>
                                    <input type="number" name="time" value="30" required>
                                </div>
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <label>Pr√©infusion (s)</label>
                                    <input type="number" name="preinfusion" value="8">
                                </div>
                                <div class="form-group">
                                    <label>WDT</label>
                                    <select name="wdt">
                                        <option value="non">Non</option>
                                        <option value="l√©ger">L√©ger</option>
                                        <option value="normal">Normal</option>
                                        <option value="profond">Profond</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <label>Channeling</label>
                                    <select name="channeling">
                                        <option value="non">Non</option>
                                        <option value="oui">Oui</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>D√©bit</label>
                                    <select name="flow">
                                        <option value="rapide">Rapide</option>
                                        <option value="stable" selected>Stable</option>
                                        <option value="lent">Lent</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Go√ªt</label>
                                <input type="text" name="taste" placeholder="tr√®s bon, bon, acide...">
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea name="notes" rows="3" placeholder="Observations..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Enregistrer le Shot</button>
                        </form>
                    </div>

                    <div class="section">
                        <h2>üìã Historique (${shots.length} shots)</h2>
                        ${shots.length === 0 ? '<p style="text-align:center; color:#888; padding:40px;">Aucun shot enregistr√©</p>' : ''}
                `;

                shots.forEach(s => {
                    html += `
                        <div class="shot-item">
                            <div class="shot-header">
                                <div style="display:flex; align-items:center; gap:12px;">
                                    <img src="${getLogo(s.coffee)}" style="width:40px; height:40px; border-radius:50%;">
                                    <div>
                                        <div class="shot-title">${s.coffee}</div>
                                        <div class="shot-date">${s.date}</div>
                                    </div>
                                </div>
                                <button class="btn btn-danger btn-small" onclick="deleteShot('${s.id}')">‚úï Supprimer</button>
                            </div>
                            <div class="shot-details">
                                <div class="detail"><strong>Dose ‚Üí Sortie</strong>${s.dose}g ‚Üí ${s.output}g (1:${s.ratio.toFixed(1)})</div>
                                <div class="detail"><strong>Mouture</strong>${s.grind}</div>
                                <div class="detail"><strong>Temps</strong>${s.time}s</div>
                                <div class="detail"><strong>Pr√©infusion</strong>${s.preinfusion}s</div>
                                <div class="detail"><strong>√Çge</strong>${s.age}j</div>
                                <div class="detail"><strong>WDT</strong>${s.wdt}</div>
                                <div class="detail"><strong>Channeling</strong>${s.channeling}</div>
                                <div class="detail"><strong>Go√ªt</strong>${s.taste || '-'}</div>
                            </div>
                            ${s.notes ? `<div style="margin-top:15px; font-size:15px; color:#666; font-style:italic;">üìù ${s.notes}</div>` : ''}
                        </div>
                    `;
                });

                html += `</div>`;
            }

            // ---------- ONGLET PAQUETS ----------
            else if (currentTab === 'bags') {
                html += `
                    <div class="section">
                        <h2>+ Nouveau Paquet</h2>
                        <form id="form-bag" onsubmit="event.preventDefault(); addBag(event)">
                            <div class="form-group">
                                <label>Nom du caf√© *</label>
                                <input type="text" name="name" placeholder="G√©d√©o, Timan√†..." required>
                            </div>
                            <div class="form-group">
                                <label>Torr√©facteur</label>
                                <input type="text" name="roaster" value="L'Arbre √† Caf√©">
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <label>Date torr√©faction (JJ/MM/AAAA) *</label>
                                    <input type="text" name="roast_date" placeholder="31/12/2025" required>
                                </div>
                                <div class="form-group">
                                    <label>Poids (g)</label>
                                    <input type="number" name="weight" value="250">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Notes</label>
                                <textarea name="notes" rows="3" placeholder="Profil aromatique..."></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Ajouter le Paquet</button>
                        </form>
                    </div>

                    <div class="section">
                        <h2>üì¶ Mes Paquets (${bags.length})</h2>
                        ${bags.length === 0 ? '<p style="text-align:center; color:#888; padding:40px;">Aucun paquet enregistr√©</p>' : ''}
                `;

                bags.forEach(b => {
                    const age = b.roast_date ? Math.floor((new Date() - new Date(b.roast_date.split('/').reverse().join('-'))) / 86400000) : 0;
                    const bgImage = getPackageImage(b.name);
                    const bgStyle = bgImage ? `style="background-image: url('${bgImage}');"` : '';
                    html += `
                        <div class="bag-item" ${bgStyle}>
                            <div class="bag-header">
                                <div style="display:flex; align-items:flex-start; gap:15px;">
                                    <img src="${getLogo(b.name)}" style="width:50px; height:50px; border-radius:50%; margin-top:4px;">
                                    <div>
                                        <div class="bag-title">${b.name}</div>
                                        <div class="bag-info">${b.roaster} ‚Ä¢ Torr√©fi√© le ${b.roast_date}<br>√Çge: ${age} jours ‚Ä¢ ${b.weight}g</div>
                                        <span class="bag-status ${b.status}">${b.status === 'active' ? '‚úì Actif' : '‚óã Termin√©'}</span>
                                    </div>
                                </div>
                                <div style="display:flex; gap:10px;">
                                    <button class="btn btn-secondary btn-small" onclick="toggleBag('${b.id}', '${b.status}')">${b.status === 'active' ? 'Terminer' : 'R√©activer'}</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteBag('${b.id}')">‚úï</button>
                                </div>
                            </div>
                            ${b.notes ? `<div style="margin-top:12px; font-size:15px; color:#666; font-style:italic;">üìù ${b.notes}</div>` : ''}
                        </div>
                    `;
                });

                html += `</div>`;
            }

            // ---------- ONGLET PARAM√àTRES ----------
            else if (currentTab === 'settings') {
                html += `
                    <div class="section">
                        <h2>‚öôÔ∏è Param√®tres</h2>
                        <div class="alert alert-success">‚úÖ Synchronis√© avec Supabase</div>
                        <h3 style="margin-top:25px; margin-bottom:15px;">Importer des donn√©es CSV</h3>
                        <div class="file-input-wrapper">
                            <button class="btn btn-secondary">üìÅ Choisir un fichier CSV</button>
                            <input type="file" accept=".csv" onchange="importCSV(this.files[0])">
                        </div>
                        <h3 style="margin-top:30px; margin-bottom:15px;">Exporter les donn√©es</h3>
                        <p style="margin-bottom:15px; color:#666;">${shots.length} shots enregistr√©s</p>
                        <button class="btn btn-primary" onclick="exportCSV()" style="width:auto;" ${shots.length === 0 ? 'disabled' : ''}>üì• T√©l√©charger CSV</button>
                    </div>
                `;
            }

            appEl.innerHTML = html;
        }

        // ---------- 7. FONCTIONS GLOBALES POUR LES √âV√âNEMENTS ----------
        window.setTab = function(tab) {
            currentTab = tab;
            render();
        };

        window.addShot = addShot;
        window.deleteShot = deleteShot;
        window.addBag = addBag;
        window.toggleBag = toggleBag;
        window.deleteBag = deleteBag;
        window.importCSV = importCSV;
        window.exportCSV = exportCSV;

        // ---------- 8. D√âMARRAGE ----------
        loadData();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6f4e37">
    <title>Espresso Tracker</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
            padding-bottom: 80px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
            overflow-x: auto;
        }
        
        .tab {
            padding: 12px 16px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 15px;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .tab.active {
            color: #6f4e37;
            border-bottom-color: #6f4e37;
            font-weight: 600;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 14px;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #6f4e37;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #6f4e37;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #5a3d2a;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .shot-list, .bag-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .shot-card, .bag-card {
            background: #fafafa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        
        .shot-header, .bag-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .shot-title, .bag-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .shot-date {
            font-size: 14px;
            color: #888;
        }
        
        .shot-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 14px;
        }
        
        .detail {
            color: #666;
        }
        
        .detail strong {
            color: #333;
        }
        
        .import-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }
        
        .file-input-wrapper input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #6f4e37 0%, #5a3d2a 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }
        
        .alert-success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .bag-info {
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }
        
        .bag-status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .bag-status.active {
            background: #4caf50;
            color: white;
        }
        
        .bag-status.finished {
            background: #9e9e9e;
            color: white;
        }
        
        @media (max-width: 600px) {
            .two-col {
                grid-template-columns: 1fr;
            }
            
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .tab {
                font-size: 14px;
                padding: 10px 12px;
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="container">
            <div class="loading">
                <h1>‚òï Chargement de Supabase...</h1>
            </div>
        </div>
    </div>

    <!-- Scripts charg√©s dans l'ordre -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <script>
        // Attendre que tous les scripts soient charg√©s
        window.addEventListener('load', function() {
            console.log('Page charg√©e, initialisation...');
            console.log('Supabase disponible:', typeof window.supabase);
            console.log('React disponible:', typeof window.React);
            
            if (typeof window.supabase === 'undefined') {
                document.getElementById('root').innerHTML = '<div class="container"><div class="card"><div class="alert alert-error"><h3>‚ùå Erreur</h3><p>Le script Supabase n\'a pas pu se charger. V√©rifiez votre connexion internet.</p></div></div></div>';
                return;
            }
            
            // Tout est charg√©, on peut d√©marrer
            initApp();
        });
        
        function initApp() {
            const { useState, useEffect } = React;
            const { createClient } = window.supabase;

            // Configuration Supabase
            const SUPABASE_URL = 'https://duzxzqmjkovrsfwhdyml.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1enh6cW1qa292cnNmd2hkeW1sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA3NjAzMzYsImV4cCI6MjA4NjMzNjMzNn0.hRUDEbr9yhd_R1Q0lLVYYppnht5tUAd5TtE9kanzvos';

            // Initialiser Supabase
            const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('‚úÖ Supabase initialis√© avec succ√®s');

            // COMPOSANT PRINCIPAL
            function EspressoTracker() {
                const [activeTab, setActiveTab] = useState('shots');
                const [shots, setShots] = useState([]);
                const [bags, setBags] = useState([]);
                const [loading, setLoading] = useState(true);
                const [message, setMessage] = useState(null);

                useEffect(() => {
                    loadData();
                }, []);

                async function loadData() {
                    try {
                        setLoading(true);
                        
                        const { data: shotsData, error: shotsError } = await supabase
                            .from('shots')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        if (shotsError) throw shotsError;
                        setShots(shotsData || []);
                        
                        const { data: bagsData, error: bagsError } = await supabase
                            .from('bags')
                            .select('*')
                            .order('created_at', { ascending: false });
                        
                        if (bagsError) throw bagsError;
                        setBags(bagsData || []);
                        
                        console.log(`‚úÖ Charg√©: ${shotsData?.length || 0} shots, ${bagsData?.length || 0} paquets`);
                    } catch (error) {
                        console.error('Erreur chargement:', error);
                        showMessage('error', 'Erreur lors du chargement: ' + error.message);
                    } finally {
                        setLoading(false);
                    }
                }

                function showMessage(type, text) {
                    setMessage({ type, text });
                    setTimeout(() => setMessage(null), 5000);
                }

                async function addShot(shot) {
                    try {
                        const { data, error } = await supabase
                            .from('shots')
                            .insert([shot])
                            .select();
                        
                        if (error) throw error;
                        
                        setShots([data[0], ...shots]);
                        showMessage('success', '‚úÖ Shot enregistr√© !');
                        setActiveTab('shots');
                    } catch (error) {
                        console.error('Erreur ajout shot:', error);
                        showMessage('error', '‚ùå Erreur: ' + error.message);
                    }
                }

                async function deleteShot(id) {
                    try {
                        const { error } = await supabase
                            .from('shots')
                            .delete()
                            .eq('id', id);
                        
                        if (error) throw error;
                        
                        setShots(shots.filter(s => s.id !== id));
                        showMessage('success', '‚úÖ Shot supprim√©');
                    } catch (error) {
                        console.error('Erreur suppression:', error);
                        showMessage('error', '‚ùå Erreur: ' + error.message);
                    }
                }

                async function handleImportCSV(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const text = e.target.result;
                            const lines = text.split('\n').filter(l => l.trim());
                            
                            const shotsToImport = [];
                            
                            for (let i = 1; i < lines.length; i++) {
                                const values = lines[i].split(',');
                                if (values.length < 10) continue;
                                
                                const shot = {
                                    date: values[0].trim(),
                                    coffee: values[1].trim(),
                                    roaster: values[2].trim(),
                                    roast_date: values[3].trim(),
                                    age: parseInt(values[4]) || 0,
                                    dose: parseFloat(values[5]) || 18,
                                    output: parseFloat(values[6]) || 36,
                                    ratio: parseFloat(values[7]) || 2,
                                    grind: parseFloat(values[8]) || 7.5,
                                    time: parseInt(values[9]) || 0,
                                    preinfusion: parseInt(values[10]) || 0,
                                    wdt: values[11]?.trim() || 'non',
                                    channeling: values[12]?.trim() || 'non',
                                    flow: values[13]?.trim() || 'stable',
                                    taste: values[14]?.trim() || '',
                                    notes: values[15]?.trim() || ''
                                };
                                
                                shotsToImport.push(shot);
                            }
                            
                            const { error } = await supabase
                                .from('shots')
                                .insert(shotsToImport);
                            
                            if (error) throw error;
                            
                            await loadData();
                            showMessage('success', `‚úÖ ${shotsToImport.length} shots import√©s !`);
                        } catch (error) {
                            console.error(error);
                            showMessage('error', '‚ùå Erreur import: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                }

                if (loading) {
                    return React.createElement('div', { className: 'container' },
                        React.createElement('div', { className: 'loading' },
                            React.createElement('h1', null, '‚òï Chargement...')
                        )
                    );
                }

                return React.createElement('div', { className: 'container' },
                    React.createElement('h1', null, '‚òï Espresso Tracker'),
                    
                    message && React.createElement('div', { className: `alert alert-${message.type}` }, message.text),
                    
                    React.createElement('div', { className: 'tabs' },
                        React.createElement('button', {
                            className: `tab ${activeTab === 'shots' ? 'active' : ''}`,
                            onClick: () => setActiveTab('shots')
                        }, 'Shots'),
                        React.createElement('button', {
                            className: `tab ${activeTab === 'add-shot' ? 'active' : ''}`,
                            onClick: () => setActiveTab('add-shot')
                        }, '+ Shot'),
                        React.createElement('button', {
                            className: `tab ${activeTab === 'settings' ? 'active' : ''}`,
                            onClick: () => setActiveTab('settings')
                        }, '‚öôÔ∏è')
                    ),

                    activeTab === 'shots' && React.createElement(ShotsList, { shots, onDelete: deleteShot }),
                    activeTab === 'add-shot' && React.createElement(AddShot, { onAdd: addShot }),
                    activeTab === 'settings' && React.createElement(Settings, { onImport: handleImportCSV, shotCount: shots.length })
                );
            }

            // LISTE DES SHOTS (version simplifi√©e pour tester)
            function ShotsList({ shots, onDelete }) {
                if (shots.length === 0) {
                    return React.createElement('div', { className: 'card' },
                        React.createElement('div', { className: 'alert alert-info' },
                            'Aucun shot enregistr√©. Importez vos donn√©es !'
                        )
                    );
                }

                return React.createElement('div', { className: 'shot-list' },
                    shots.map(shot => 
                        React.createElement('div', { key: shot.id, className: 'shot-card' },
                            React.createElement('div', { className: 'shot-header' },
                                React.createElement('div', null,
                                    React.createElement('div', { className: 'shot-title' }, shot.coffee),
                                    React.createElement('div', { className: 'shot-date' }, shot.date)
                                ),
                                React.createElement('button', {
                                    className: 'btn btn-danger btn-small',
                                    onClick: () => {
                                        if (window.confirm('Supprimer ce shot ?')) {
                                            onDelete(shot.id);
                                        }
                                    }
                                }, '‚úï')
                            ),
                            React.createElement('div', { className: 'shot-details' },
                                React.createElement('div', { className: 'detail' },
                                    React.createElement('strong', null, shot.dose + 'g'),
                                    ' ‚Üí ',
                                    React.createElement('strong', null, shot.output + 'g'),
                                    ` (1:${shot.ratio.toFixed(1)})`
                                ),
                                React.createElement('div', { className: 'detail' },
                                    'Mouture: ',
                                    React.createElement('strong', null, shot.grind)
                                ),
                                React.createElement('div', { className: 'detail' },
                                    'Temps: ',
                                    React.createElement('strong', null, shot.time + 's')
                                )
                            )
                        )
                    )
                );
            }

            // AJOUTER UN SHOT (version simple)
            function AddShot({ onAdd }) {
                const [formData, setFormData] = useState({
                    coffee: 'G√©d√©o',
                    roaster: 'L\'Arbre √† Caf√©',
                    roast_date: '',
                    dose: 18,
                    output: 38,
                    grind: 7.5,
                    time: 30,
                    preinfusion: 8,
                    wdt: 'non',
                    channeling: 'non',
                    flow: 'stable',
                    taste: '',
                    notes: ''
                });

                function handleSubmit(e) {
                    e.preventDefault();
                    
                    const age = formData.roast_date ? 
                        Math.floor((new Date() - new Date(formData.roast_date.split('/').reverse().join('-'))) / (1000 * 60 * 60 * 24)) : 0;
                    
                    const shot = {
                        date: new Date().toLocaleString('fr-FR'),
                        coffee: formData.coffee,
                        roaster: formData.roaster,
                        roast_date: formData.roast_date,
                        age,
                        dose: parseFloat(formData.dose),
                        output: parseFloat(formData.output),
                        ratio: parseFloat((formData.output / formData.dose).toFixed(2)),
                        grind: parseFloat(formData.grind),
                        time: parseInt(formData.time),
                        preinfusion: parseInt(formData.preinfusion),
                        wdt: formData.wdt,
                        channeling: formData.channeling,
                        flow: formData.flow,
                        taste: formData.taste,
                        notes: formData.notes
                    };
                    
                    onAdd(shot);
                }

                return React.createElement('div', { className: 'card' },
                    React.createElement('h2', null, 'Nouveau Shot'),
                    React.createElement('form', { onSubmit: handleSubmit },
                        React.createElement('div', { className: 'form-group' },
                            React.createElement('label', null, 'Caf√© *'),
                            React.createElement('input', {
                                type: 'text',
                                value: formData.coffee,
                                onChange: (e) => setFormData({...formData, coffee: e.target.value}),
                                required: true
                            })
                        ),
                        React.createElement('div', { className: 'two-col' },
                            React.createElement('div', { className: 'form-group' },
                                React.createElement('label', null, 'Dose (g) *'),
                                React.createElement('input', {
                                    type: 'number',
                                    step: '0.1',
                                    value: formData.dose,
                                    onChange: (e) => setFormData({...formData, dose: e.target.value}),
                                    required: true
                                })
                            ),
                            React.createElement('div', { className: 'form-group' },
                                React.createElement('label', null, 'Sortie (g) *'),
                                React.createElement('input', {
                                    type: 'number',
                                    step: '0.1',
                                    value: formData.output,
                                    onChange: (e) => setFormData({...formData, output: e.target.value}),
                                    required: true
                                })
                            )
                        ),
                        React.createElement('div', { className: 'two-col' },
                            React.createElement('div', { className: 'form-group' },
                                React.createElement('label', null, 'Mouture *'),
                                React.createElement('input', {
                                    type: 'number',
                                    step: '0.1',
                                    value: formData.grind,
                                    onChange: (e) => setFormData({...formData, grind: e.target.value}),
                                    required: true
                                })
                            ),
                            React.createElement('div', { className: 'form-group' },
                                React.createElement('label', null, 'Temps (s) *'),
                                React.createElement('input', {
                                    type: 'number',
                                    value: formData.time,
                                    onChange: (e) => setFormData({...formData, time: e.target.value}),
                                    required: true
                                })
                            )
                        ),
                        React.createElement('button', {
                            type: 'submit',
                            className: 'btn btn-primary',
                            style: { width: '100%' }
                        }, 'Enregistrer le Shot')
                    )
                );
            }

            // PARAM√àTRES
            function Settings({ onImport, shotCount }) {
                return React.createElement('div', { className: 'card' },
                    React.createElement('h2', null, 'Param√®tres'),
                    React.createElement('div', { className: 'alert alert-success' },
                        '‚úÖ Connect√© √† Supabase !'
                    ),
                    React.createElement('div', { style: { marginTop: '20px' } },
                        React.createElement('h3', null, 'Importer des donn√©es CSV'),
                        React.createElement('p', { style: { color: '#666', fontSize: '14px', marginBottom: '15px' } },
                            'Importez votre ancien fichier CSV.'
                        ),
                        React.createElement('div', { className: 'file-input-wrapper' },
                            React.createElement('button', { className: 'btn btn-secondary' }, 'üìÅ Choisir un fichier CSV'),
                            React.createElement('input', {
                                type: 'file',
                                accept: '.csv',
                                onChange: onImport
                            })
                        )
                    )
                );
            }

            // Render
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(React.createElement(EspressoTracker));
        }
    </script>
</body>
</html>
